<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Guid - Short Video App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #000000);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #aaaaaa);
            --tg-link: var(--tg-theme-link-color, #1c9eff);
            --tg-button: var(--tg-theme-button-color, #1c9eff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #1c1c1e);
            --accent-red: #ff3b30;
            --border-radius: 12px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--tg-bg); color: var(--tg-text); height: 100vh; overflow: hidden; position: relative; }
        .page { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: none; overflow-y: auto; padding-bottom: 60px; opacity: 0; transform: scale(0.98); transition: opacity 0.3s ease, transform 0.3s ease; background-color: var(--tg-bg); }
        .page.active { display: block; opacity: 1; transform: scale(1); }
        #home-page { background-color: #000; }
        .video-container { width: 100%; height: 100%; position: relative; overflow: hidden; }
        .video-wrapper { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: none; transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .video-wrapper.active { display: block; z-index: 2; transform: translateY(0); }
        .video-wrapper.next { display: block; z-index: 1; transform: translateY(100%); }
        .video-wrapper.prev { display: block; z-index: 1; transform: translateY(-100%); }
        .video-player { width: 100%; height: 100%; object-fit: cover; background-color: #000; }
        .video-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 40%); pointer-events: none; }
        .video-info { position: absolute; bottom: 65px; left: 15px; z-index: 10; max-width: 70%; color: #fff; }
        .username { font-weight: bold; font-size: 16px; margin-bottom: 5px; cursor: pointer; }
        .description { font-size: 14px; margin-bottom: 10px; line-height: 1.4; }
        .right-sidebar { position: absolute; right: 15px; bottom: 65px; display: flex; flex-direction: column; align-items: center; z-index: 10; color: #fff; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #fff; margin-bottom: 25px; background-color: var(--tg-secondary-bg); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; cursor: pointer; position: relative; }
        .follow-button { position: absolute; bottom: -10px; background-color: var(--accent-red); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; display: flex; align-items: center; justify-content: center; border: 2px solid #000; cursor: pointer; }
        .action-button { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; cursor: pointer; }
        .action-button:last-child { margin-bottom: 0; }
        .action-icon { font-size: 30px; margin-bottom: 5px; transition: transform 0.2s ease; }
        .action-icon.liked { color: var(--accent-red); }
        .action-button:active .action-icon { transform: scale(0.9); }
        .action-count { font-size: 13px; font-weight: 500; }
        .mute-button { position: absolute; top: 66px; right: 15px; z-index: 11; color: #fff; font-size: 24px; cursor: pointer; text-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .header { padding: 15px; font-size: 20px; font-weight: bold; position: sticky; top: 0; background-color: var(--tg-bg); z-index: 10; border-bottom: 1px solid var(--tg-secondary-bg); }
        .search-bar { display: flex; padding: 15px; position: sticky; top: 0; background-color: var(--tg-bg); z-index: 11; }
        .search-input { flex: 1; padding: 12px 15px; border-radius: var(--border-radius); border: none; background-color: var(--tg-secondary-bg); color: var(--tg-text); font-size: 16px; }
        .search-input::placeholder { color: var(--tg-hint); }
        .section-title { font-size: 18px; margin: 20px 15px 15px; font-weight: bold; }
        .profile-header { padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; background-color: var(--tg-secondary-bg); margin-bottom: 15px; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold; border: 3px solid var(--tg-link); }
        .profile-name { font-size: 22px; font-weight: bold; margin-bottom: 5px; }
        .profile-username { font-size: 16px; color: var(--tg-hint); margin-bottom: 15px; }
        .profile-stats { display: flex; justify-content: space-around; width: 100%; margin-bottom: 20px; padding: 0 20px; }
        .profile-stat { text-align: center; }
        .stat-value { font-size: 18px; font-weight: bold; }
        .stat-label { font-size: 12px; color: var(--tg-hint); }
        .profile-actions { display: flex; gap: 10px; width: 100%; padding: 0 15px; margin-bottom: 20px; }
        .profile-button { flex: 1; padding: 12px; border-radius: var(--border-radius); font-size: 14px; font-weight: bold; text-align: center; cursor: pointer; transition: background-color 0.2s ease, opacity 0.2s ease; }
        .profile-button:active { opacity: 0.8; }
        .profile-button-primary { background-color: var(--tg-button); color: var(--tg-button-text); }
        .profile-button-secondary { background-color: var(--tg-secondary-bg); color: var(--tg-text); }
        .tabs-container { display: flex; border-bottom: 1px solid var(--tg-secondary-bg); position: sticky; top: 0; background-color: var(--tg-bg); z-index: 10; }
        .tab { flex: 1; text-align: center; padding: 15px 0; font-size: 16px; position: relative; cursor: pointer; color: var(--tg-hint); }
        .tab.active { color: var(--tg-text); font-weight: bold; }
        .tab.active::after { content: ''; position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; background-color: var(--tg-link); border-radius: 3px 3px 0 0; }
        .content-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 2px; }
        .grid-item { aspect-ratio: 9/16; background-color: var(--tg-secondary-bg); position: relative; cursor: pointer; }
        .grid-item-thumbnail { width: 100%; height: 100%; object-fit: cover; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 40vh; text-align: center; padding: 20px; color: var(--tg-hint); }
        .empty-state-icon { font-size: 50px; margin-bottom: 20px; }
        .empty-state-text { font-size: 16px; margin-bottom: 15px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background-color: var(--tg-bg); display: flex; justify-content: space-around; align-items: center; z-index: 100; border-top: 1px solid var(--tg-secondary-bg); }
        .nav-button { display: flex; flex-direction: column; align-items: center; color: var(--tg-hint); font-size: 10px; cursor: pointer; padding: 5px; flex: 1; transition: color 0.2s ease; }
        .nav-icon { font-size: 24px; margin-bottom: 3px; }
        .nav-button.active { color: var(--tg-text); font-weight: bold; }
        .create-nav-button { background: var(--tg-button); width: 45px; height: 35px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--tg-button-text); font-size: 22px; }
        .loading-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; display: flex; flex-direction: column; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--tg-secondary-bg); border-radius: 50%; border-top-color: var(--tg-link); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .comments-panel { position: fixed; bottom: 0; left: 0; width: 100%; height: 80vh; background-color: var(--tg-secondary-bg); border-radius: var(--border-radius) var(--border-radius) 0 0; transform: translateY(100%); transition: transform 0.3s ease-out; z-index: 200; display: flex; flex-direction: column; }
        .comments-panel.open { transform: translateY(0); }
        .comments-header { padding: 15px; text-align: center; font-weight: bold; border-bottom: 1px solid var(--tg-hint); position: relative; flex-shrink: 0; }
        .comments-header .close-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px; }
        .comments-list { flex-grow: 1; overflow-y: auto; padding: 10px 15px; }
        .comment-item { display: flex; margin-bottom: 15px; }
        .comment-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--tg-bg); margin-right: 10px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .comment-content .username { font-size: 14px; }
        .comment-content .text { font-size: 14px; line-height: 1.4; }
        .comment-input-container { display: flex; padding: 10px 15px; border-top: 1px solid var(--tg-hint); flex-shrink: 0; }
        .comment-input { flex-grow: 1; background-color: var(--tg-bg); border: none; padding: 10px; border-radius: var(--border-radius); color: var(--tg-text); }
        .comment-send-btn { background: none; border: none; color: var(--tg-link); font-size: 24px; margin-left: 10px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--tg-hint); font-size: 14px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border-radius: var(--border-radius); border: 1px solid var(--tg-secondary-bg); background-color: var(--tg-secondary-bg); color: var(--tg-text); font-size: 16px; }
        #upload-progress { width: 100%; height: 5px; background-color: var(--tg-secondary-bg); border-radius: 5px; margin-top: 10px; display: none; }
        #upload-progress-bar { width: 0; height: 100%; background-color: var(--tg-link); border-radius: 5px; transition: width 0.2s; }
        
        /* --- СТИЛИ ДЛЯ ОНБОРДИНГА --- */
        #onboarding-page { display: flex; justify-content: center; align-items: center; }
        .onboarding-container { display: flex; flex-direction: column; width: 100%; height: 100%; padding: 20px; max-width: 500px; }
        .onboarding-progress { display: flex; gap: 5px; width: 100%; margin-bottom: 30px; flex-shrink: 0; }
        .progress-step { flex: 1; height: 4px; background-color: var(--tg-secondary-bg); border-radius: 2px; transition: background-color 0.3s ease; }
        .progress-step.active { background-color: var(--tg-link); }
        .onboarding-step { display: none; flex-direction: column; text-align: center; flex-grow: 1; opacity: 0; transition: opacity 0.4s ease-in-out; }
        .onboarding-step.active { display: flex; opacity: 1; }
        .onboarding-step h2 { font-size: 26px; font-weight: 700; margin-bottom: 10px; }
        .onboarding-step p { font-size: 16px; color: var(--tg-hint); margin-bottom: 30px; }
        .onboarding-options { display: flex; flex-direction: column; gap: 15px; width: 100%; margin-bottom: 20px; flex-grow: 1; overflow-y: auto; }
        .onboarding-option { padding: 20px; background-color: var(--tg-secondary-bg); border-radius: var(--border-radius); cursor: pointer; border: 2px solid transparent; transition: all 0.2s ease; display: flex; align-items: center; gap: 15px; text-align: left; font-size: 17px; font-weight: 500; }
        .onboarding-option .option-icon { font-size: 24px; color: var(--tg-hint); width: 30px; text-align: center; transition: color 0.2s ease; }
        .onboarding-option:hover { border-color: var(--tg-hint); }
        .onboarding-option.selected { border-color: var(--tg-link); background-color: color-mix(in srgb, var(--tg-link) 15%, var(--tg-secondary-bg)); }
        .onboarding-option.selected .option-icon { color: var(--tg-link); }
        #city-list { max-height: 40vh; overflow-y: auto; border: 1px solid var(--tg-secondary-bg); border-radius: var(--border-radius); padding: 5px; }
        .city-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; transition: background-color 0.2s ease; }
        .city-item:hover, .city-item.selected { background-color: var(--tg-secondary-bg); }
        .onboarding-nav { display: flex; gap: 10px; width: 100%; margin-top: auto; padding-top: 15px; flex-shrink: 0; }
        .onboarding-button { flex: 1; padding: 15px; border-radius: var(--border-radius); font-size: 16px; font-weight: bold; text-align: center; cursor: pointer; border: none; transition: all 0.2s ease; }
        .onboarding-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .onboarding-button-next { background-color: var(--tg-button); color: var(--tg-button-text); }
        .onboarding-button-back { background-color: var(--tg-secondary-bg); color: var(--tg-text); }
        
        /* Стили для фильтров */
        .filters-container { display: flex; gap: 10px; padding: 10px 15px; background-color: var(--tg-bg); }
        .filter-select { flex: 1; }

        /* Стили для страницы загрузки */
        #create-page-content { padding: 15px; }
        #video-preview-container { display: none; margin-bottom: 20px; }
        #video-preview { width: 100%; max-height: 40vh; border-radius: var(--border-radius); background-color: #000; }
        #upload-form { display: none; }
        #select-file-button-container { display: flex; justify-content: center; align-items: center; min-height: 50vh; }
    </style>
</head>
<body>
    <!-- Pages -->
    <div id="home-page" class="page active"><div class="video-container" id="video-container"><div class="loading-indicator"><div class="spinner"></div></div></div></div>
    <div id="discover-page" class="page">
        <div class="search-bar"><input type="text" class="search-input" placeholder="Поиск видео и пользователей"></div>
        <div class="filters-container">
            <select id="filter-discipline" class="filter-select form-group"><option value="">Все дисциплины</option></select>
            <select id="filter-style" class="filter-select form-group"><option value="">Все стили</option></select>
            <select id="filter-city" class="filter-select form-group"><option value="">Все города</option></select>
        </div>
        <div id="discover-content" class="content-grid"></div>
        <div id="discover-empty" class="empty-state" style="display: none;"><div class="empty-state-icon"><i class="fas fa-search"></i></div><div class="empty-state-text">Ничего не найдено</div></div>
    </div>
    <div id="create-page" class="page">
        <div class="header">Создать видео</div>
        <div id="create-page-content">
            <input type="file" id="video-file-input" accept="video/*" style="display: none;">
            
            <div id="select-file-button-container">
                 <div class="profile-button profile-button-primary" id="select-file-btn">Выбрать видео</div>
            </div>

            <div id="video-preview-container">
                <video id="video-preview" controls></video>
            </div>

            <div id="upload-form">
                <div class="form-group">
                    <label for="video-description">Описание</label>
                    <textarea id="video-description" rows="3" placeholder="Расскажите о вашем видео..."></textarea>
                </div>
                <div class="form-group">
                    <label for="video-discipline">Дисциплина</label>
                    <select id="video-discipline"></select>
                </div>
                <div class="form-group">
                    <label for="video-style">Стиль</label>
                    <select id="video-style"></select>
                </div>
                <!-- Кнопка публикации будет управляться через MainButton -->
                <div id="upload-progress"><div id="upload-progress-bar"></div></div>
            </div>
        </div>
    </div>
    <div id="inbox-page" class="page"><div class="header">Входящие</div><div id="inbox-content"><div class="empty-state"><div class="empty-state-icon"><i class="far fa-paper-plane"></i></div><div class="empty-state-text">Здесь будут ваши чаты</div></div></div></div>
    <div id="profile-page" class="page"></div>
    <div id="edit-profile-page" class="page">
        <div class="header">Редактировать профиль</div>
        <div style="padding: 15px;">
            <div class="form-group">
                <label for="edit-first-name">Имя</label>
                <input type="text" id="edit-first-name">
            </div>
            <div class="form-group">
                <label for="edit-last-name">Фамилия</label>
                <input type="text" id="edit-last-name">
            </div>
            <div class="form-group">
                <label for="edit-username">Имя пользователя</label>
                <input type="text" id="edit-username">
            </div>
             <!-- Кнопка сохранения будет управляться через MainButton -->
        </div>
    </div>
    <div id="user-profile-page" class="page"></div>
    <!-- Новая страница для просмотра одного видео -->
    <div id="video-viewer-page" class="page"></div>
    
    <!-- ОБНОВЛЕННАЯ СТРАНИЦА АНКЕТЫ -->
    <div id="onboarding-page" class="page">
        <div class="onboarding-container">
            <div class="onboarding-progress">
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
            </div>

            <div id="onboarding-step-1" class="onboarding-step">
                <h2>Расскажите о себе</h2>
                <p>Выберите основную дисциплину, которой вы занимаетесь.</p>
                <div class="onboarding-options">
                    <div class="onboarding-option" data-discipline="Ролики"><i class="option-icon fas fa-skating"></i>Ролики</div>
                    <div class="onboarding-option" data-discipline="Скейт"><i class="option-icon fas fa-skateboard"></i>Скейтборд</div>
                    <div class="onboarding-option" data-discipline="BMX"><i class="option-icon fas fa-bicycle"></i>BMX</div>
                </div>
                <div class="onboarding-nav">
                    <button class="onboarding-button onboarding-button-next" id="ob-step1-next" disabled>Далее</button>
                </div>
            </div>

            <div id="onboarding-step-2" class="onboarding-step">
                <h2>Какой ваш стиль?</h2>
                <p>Это поможет нам рекомендовать вам интересный контент.</p>
                <div id="style-options" class="onboarding-options"></div>
                <div class="onboarding-nav">
                    <button class="onboarding-button onboarding-button-back" id="ob-step2-back">Назад</button>
                    <button class="onboarding-button onboarding-button-next" id="ob-step2-next" disabled>Далее</button>
                </div>
            </div>

            <div id="onboarding-step-3" class="onboarding-step">
                <h2>Из какого вы города?</h2>
                <p>Найдите райдеров и споты рядом с вами.</p>
                <input type="text" id="city-search" class="search-input" placeholder="Начните вводить город..." style="margin-bottom: 15px; width: 100%;">
                <div id="city-list" class="onboarding-options"></div>
                 <div class="onboarding-nav">
                    <button class="onboarding-button onboarding-button-back" id="ob-step3-back">Назад</button>
                    <button class="onboarding-button onboarding-button-next" id="ob-step3-finish" disabled>Завершить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Comments Panel -->
    <div id="comments-panel" class="comments-panel">
        <div class="comments-header">
            <span id="comments-count">0 комментариев</span>
            <i class="fas fa-times close-btn" id="close-comments-btn"></i>
        </div>
        <div class="comments-list" id="comments-list"></div>
        <div class="comment-input-container">
            <input type="text" id="comment-input" class="comment-input" placeholder="Ваш комментарий...">
            <button id="send-comment-btn" class="comment-send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav"><div class="nav-button active" data-page="home-page"><div class="nav-icon"><i class="fas fa-home"></i></div><div>Главная</div></div><div class="nav-button" data-page="discover-page"><div class="nav-icon"><i class="fas fa-search"></i></div><div>Интересное</div></div><div class="nav-button create-nav-button"><i class="fas fa-plus"></i></div><div class="nav-button" data-page="inbox-page"><div class="nav-icon"><i class="far fa-paper-plane"></i></div><div>Входящие</div></div><div class="nav-button" data-page="profile-page"><div class="nav-icon"><i class="far fa-user"></i></div><div>Профиль</div></div></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            tg.disableVerticalSwipes();
            tg.enableClosingConfirmation();

            const SUPABASE_URL = 'https://bbtkaiondhlxaxvcvces.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJidGthaW9uZGhseGF4dmN2Y2VzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3NDcyNDUsImV4cCI6MjA2OTMyMzI0NX0.yE-IT4RJoJQC8hAtSCgh9Nh4fX-cADts-DDxuOnVloY';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            const initDataUnsafe = tg.initDataUnsafe || {};
            const user = initDataUnsafe.user || { id: 123456789, first_name: 'Test', last_name: 'User', username: 'testuser' };
            
            // --- Глобальное состояние приложения ---
            let videos = [];
            let allFetchedVideos = []; // Кэш для страницы "Интересное"
            let currentVideoIndex = 0;
            let isSwiping = false;
            let activeCommentsVideoId = null;
            let selectedFile = null;
            let isInitialized = false;
            let userProfile = null;
            let onboardingData = {};
            let isGloballyMuted = false;

            // --- Данные для анкеты и фильтров ---
            const disciplines = {
                'Ролики': ['Агрессив', 'Слалом', 'Фрискейт', 'Спидскейтинг', 'Даунхилл', 'Арт-скейтинг'],
                'Скейт': ['Стрит', 'Парк', 'Верт', 'Лонгборд', 'Круизинг', 'Даунхилл'],
                'BMX': ['Стрит', 'Парк', 'Дерт', 'Верт', 'Флэтленд', 'Рейсинг']
            };
            // Этот список городов значительно расширен. В идеале, его нужно заменить на API.
            const cities = ['Москва', 'Санкт-Петербург', 'Новосибирск', 'Екатеринбург', 'Казань', 'Нижний Новгород', 'Челябинск', 'Самара', 'Омск', 'Ростов-на-Дону', 'Уфа', 'Красноярск', 'Воронеж', 'Пермь', 'Волгоград', 'Краснодар', 'Саратов', 'Тюмень', 'Тольятти', 'Ижевск', 'Барнаул', 'Ульяновск', 'Иркутск', 'Хабаровск', 'Ярославль', 'Владивосток', 'Махачкала', 'Томск', 'Оренбург', 'Кемерово', 'Новокузнецк', 'Рязань', 'Астрахань', 'Набережные Челны', 'Пенза', 'Липецк', 'Киров', 'Чебоксары', 'Тула', 'Калининград', 'Балашиха', 'Курск', 'Ставрополь', 'Севастополь', 'Сочи', 'Тверь', 'Магнитогорск', 'Иваново', 'Брянск', 'Белгород', 'Сургут', 'Владимир', 'Нижний Тагил', 'Архангельск', 'Симферополь', 'Чита', 'Калуга', 'Смоленск', 'Волжский', 'Саранск', 'Череповец', 'Курган', 'Орёл', 'Вологда', 'Владикавказ', 'Подольск', 'Грозный', 'Мурманск', 'Тамбов', 'Стерлитамак', 'Петрозаводск', 'Кострома', 'Нижневартовск', 'Йошкар-Ола', 'Новороссийск', 'Комсомольск-на-Амуре', 'Таганрог'];

            // --- Инициализация приложения ---
            async function main(forceRefresh = false) {
                userProfile = await upsertUserProfile();

                if (!userProfile.discipline || !userProfile.style || !userProfile.city) {
                    startOnboarding();
                    return;
                }
                
                const startParam = tg.initDataUnsafe.start_param;
                if (startParam && !isInitialized) {
                    await handleStartParam(startParam);
                } else {
                     if (forceRefresh || videos.length === 0) {
                        videos = await fetchVideos();
                        allFetchedVideos = [...videos]; // Кэшируем для страницы "Интересное"
                    }
                    navigateToPage('home-page');
                    renderVideoFeed();
                }
               
                populateProfile(user.id);
                populateFilters();
                isInitialized = true;
            }

            async function handleStartParam(param) {
                if (param.startsWith('video')) {
                    const videoId = parseInt(param.substring(5), 10);
                    await fetchAndShowVideo(videoId);
                } else if (param.startsWith('user')) {
                    const userId = parseInt(param.substring(4), 10);
                    navigateToUserProfile(userId);
                }
            }

            // --- Работа с API (Supabase) ---
            async function upsertUserProfile() {
                const { data, error } = await supabase.from('profiles').upsert({
                    id: user.id,
                    username: user.username,
                    first_name: user.first_name,
                    last_name: user.last_name || null
                }, { onConflict: 'id' }).select().single();
                if (error) console.error('Error upserting profile:', error);
                return data;
            }

            function getFullVideoQuery() {
                return `
                    id, video_url, description, user_id, discipline, style,
                    profiles!videos_user_id_fkey( id, username, first_name, last_name, city ),
                    likes ( user_id ),
                    saves ( user_id ),
                    comments ( id )
                `;
            }

            function formatVideoData(v) {
                 return {
                    id: v.id, url: v.video_url, description: v.description, userId: v.user_id,
                    username: v.profiles?.username || 'unknown', 
                    author: v.profiles,
                    likesCount: v.likes.length, commentsCount: v.comments.length,
                    isLiked: v.likes.some(like => like.user_id === user.id),
                    isSaved: v.saves.some(save => save.user_id === user.id)
                };
            }

            async function fetchVideos(filters = {}) {
                let query = supabase.from('videos').select(getFullVideoQuery()).order('created_at', { ascending: false });

                if (filters.discipline) query = query.eq('discipline', filters.discipline);
                if (filters.style) query = query.eq('style', filters.style);
                if (filters.city) query = query.eq('profiles.city', filters.city);
                if (filters.searchQuery) query = query.or(`description.ilike.%${filters.searchQuery}%,profiles.username.ilike.%${filters.searchQuery}%`);


                const { data, error } = await query;

                if (error) {
                    console.error('Error fetching videos:', error);
                    tg.showAlert(`Не удалось загрузить видео: ${error.message}.`);
                    return [];
                }
                
                return data.map(formatVideoData);
            }

            async function fetchAndShowVideo(videoId) {
                const { data, error } = await supabase.from('videos').select(getFullVideoQuery()).eq('id', videoId).single();
                if (error || !data) {
                    console.error('Error fetching single video:', error);
                    tg.showAlert('Не удалось найти это видео.');
                    await main(); // Возвращаемся к обычному запуску
                    return;
                }
                const videoData = formatVideoData(data);
                openVideoViewer(videoData);
            }
            
            async function fetchProfileStats(userId) {
                const { count: followingCount } = await supabase.from('followers').select('*', { count: 'exact', head: true }).eq('follower_id', userId);
                const { count: followersCount } = await supabase.from('followers').select('*', { count: 'exact', head: true }).eq('followed_id', userId);
                const { data: userVideos, error: videosError } = await supabase.from('videos').select('id').eq('user_id', userId);
                
                if (videosError) {
                    console.error('Error fetching user videos for stats', videosError);
                    return { following: 0, followers: 0, likes: 0 };
                }

                const videoIds = userVideos.map(v => v.id);
                let totalLikes = 0;
                if (videoIds.length > 0) {
                    const { count, error: likesError } = await supabase.from('likes').select('*', { count: 'exact', head: true }).in('video_id', videoIds);
                    if (!likesError) totalLikes = count;
                }
                
                return {
                    following: followingCount || 0,
                    followers: followersCount || 0,
                    likes: totalLikes
                };
            }

            // --- Рендеринг и UI ---

            function createVideoElement(videoData, classNames = '') {
                const videoWrapper = document.createElement('div');
                videoWrapper.className = `video-wrapper ${classNames}`;
                videoWrapper.dataset.videoId = videoData.id;

                videoWrapper.innerHTML = `
                    <video class="video-player" src="${videoData.url}" loop playsinline></video>
                    <div class="mute-button"><i class="fas fa-volume-high"></i></div>
                    <div class="video-overlay"></div>
                    <div class="loading-indicator"><div class="spinner"></div></div>
                    <div class="video-info">
                        <div class="username" data-user-id="${videoData.userId}">@${videoData.username}</div>
                        <div class="description">${videoData.description}</div>
                    </div>
                    <div class="right-sidebar">
                        <div class="avatar" data-user-id="${videoData.userId}">${(videoData.username || 'U').charAt(0).toUpperCase()}</div>
                        <div class="action-button like-btn">
                            <i class="action-icon ${videoData.isLiked ? 'fas liked' : 'far'} fa-heart"></i>
                            <div class="action-count">${videoData.likesCount}</div>
                        </div>
                        <div class="action-button comment-btn">
                            <i class="action-icon far fa-comment-dots"></i>
                            <div class="action-count">${videoData.commentsCount}</div>
                        </div>
                        <div class="action-button save-btn">
                            <i class="action-icon ${videoData.isSaved ? 'fas' : 'far'} fa-bookmark"></i>
                        </div>
                        <div class="action-button share-btn">
                            <i class="action-icon fas fa-share"></i>
                        </div>
                    </div>`;
                
                const videoPlayer = videoWrapper.querySelector('.video-player');
                const muteButton = videoWrapper.querySelector('.mute-button');

                muteButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    isGloballyMuted = !isGloballyMuted;
                    videoPlayer.muted = isGloballyMuted;
                    muteButton.querySelector('i').className = isGloballyMuted ? 'fas fa-volume-mute' : 'fas fa-volume-high';
                });

                videoWrapper.querySelector('.like-btn').addEventListener('click', (e) => { e.stopPropagation(); handleLike(videoWrapper, videoData); });
                videoWrapper.querySelector('.save-btn').addEventListener('click', (e) => { e.stopPropagation(); handleSave(videoWrapper, videoData); });
                videoWrapper.querySelector('.comment-btn').addEventListener('click', (e) => { e.stopPropagation(); openComments(videoData.id); });
                videoWrapper.querySelector('.share-btn').addEventListener('click', (e) => { e.stopPropagation(); handleShare(videoData); });
                videoWrapper.querySelector('.username').addEventListener('click', (e) => { e.stopPropagation(); navigateToUserProfile(videoData.userId); });
                videoWrapper.querySelector('.avatar').addEventListener('click', (e) => { e.stopPropagation(); navigateToUserProfile(videoData.userId); });

                let clickTimer = null;
                videoWrapper.addEventListener('click', (e) => {
                    if (e.target.closest('.video-info, .right-sidebar, .mute-button')) return;
                    
                    if (clickTimer === null) {
                        clickTimer = setTimeout(() => {
                            clickTimer = null;
                            if (videoPlayer) {
                                if (videoPlayer.paused) videoPlayer.play();
                                else videoPlayer.pause();
                            }
                        }, 300);
                    } else {
                        clearTimeout(clickTimer);
                        clickTimer = null;
                        handleLike(videoWrapper, videoData, true);
                    }
                });
                
                updateFollowButton(videoWrapper, videoData.userId);
                return videoWrapper;
            }
            
            function renderVideoFeed() {
                const videoContainer = document.getElementById('video-container');
                videoContainer.innerHTML = '<div class="loading-indicator"><div class="spinner"></div></div>';
                if (videos.length === 0) {
                    videoContainer.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-video-slash"></i></div><div class="empty-state-text">Пока нет видео. Загрузите первое!</div></div>`;
                    return;
                }
                videoContainer.innerHTML = '';
                const prevIndex = (currentVideoIndex - 1 + videos.length) % videos.length;
                const nextIndex = (currentVideoIndex + 1) % videos.length;
                videoContainer.append(createVideoElement(videos[prevIndex], 'prev'), createVideoElement(videos[currentVideoIndex], 'active'), createVideoElement(videos[nextIndex], 'next'));
                playCurrentVideo();
            }

            function playCurrentVideo() {
                document.querySelectorAll('.video-player').forEach(v => v.pause());

                const activeVideoWrapper = document.querySelector('.video-wrapper.active');
                if (!activeVideoWrapper) return;

                const activeVideo = activeVideoWrapper.querySelector('.video-player');
                const loadingIndicator = activeVideoWrapper.querySelector('.loading-indicator');
                const muteButtonIcon = activeVideoWrapper.querySelector('.mute-button i');

                if (activeVideo) {
                    activeVideo.currentTime = 0;
                    activeVideo.muted = isGloballyMuted;
                    if (muteButtonIcon) muteButtonIcon.className = isGloballyMuted ? 'fas fa-volume-mute' : 'fas fa-volume-high';
                    
                    loadingIndicator.style.display = 'flex';

                    const playPromise = activeVideo.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.error("Autoplay failed, trying muted:", error);
                            isGloballyMuted = true;
                            activeVideo.muted = true;
                            if (muteButtonIcon) muteButtonIcon.className = 'fas fa-volume-mute';
                            activeVideo.play();
                        });
                    }

                    activeVideo.oncanplaythrough = () => {
                        loadingIndicator.style.display = 'none';
                    };
                }
            }
            
            function navigateVideo(direction) {
                if (isSwiping || videos.length <= 1) return;
                isSwiping = true;
                currentVideoIndex = (currentVideoIndex + direction + videos.length) % videos.length;
                renderVideoFeed(); 
                tg.HapticFeedback.impactOccurred('light');
                setTimeout(() => { isSwiping = false; }, 400);
            }

            function createGridItem(video) {
                const item = document.createElement('div');
                item.className = 'grid-item';
                item.innerHTML = `<video muted playsinline class="grid-item-thumbnail" src="${video.url}#t=0.5" preload="metadata"></video>`;
                item.addEventListener('click', () => {
                   openVideoViewer(video);
                });
                return item;
            }

            function openVideoViewer(videoData) {
                const viewerPage = document.getElementById('video-viewer-page');
                viewerPage.innerHTML = ''; // Очищаем предыдущее видео
                const videoWrapper = createVideoElement(videoData, 'active');
                viewerPage.appendChild(videoWrapper);
                navigateToPage('video-viewer-page');
                const videoPlayer = videoWrapper.querySelector('.video-player');
                if (videoPlayer) {
                    videoPlayer.muted = isGloballyMuted;
                    videoPlayer.play().catch(e => console.error("Play error in viewer:", e));
                }
            }

            function renderGridContent(containerId, data, emptyText = "Здесь пока пусто") {
                const grid = document.getElementById(containerId);
                grid.innerHTML = '';
                if (!data || data.length === 0) {
                    grid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><div class="empty-state-icon"><i class="fas fa-video-slash"></i></div><div class="empty-state-text">${emptyText}</div></div>`;
                    return;
                }
                data.forEach(video => grid.appendChild(createGridItem(video)));
            }
            
            async function populateProfile(profileId) {
                const isMyProfile = profileId === user.id;
                const pageId = isMyProfile ? 'profile-page' : 'user-profile-page';
                const page = document.getElementById(pageId);
                page.innerHTML = '<div class="loading-indicator"><div class="spinner"></div></div>';
                
                const { data: profile, error } = await supabase.from('profiles').select().eq('id', profileId).single();
                if (error) { console.error('Error fetching profile', error); page.innerHTML = 'Не удалось загрузить профиль.'; return; }

                const stats = await fetchProfileStats(profileId);
                
                const profileActionsHTML = isMyProfile ? `
                    <div class="profile-button profile-button-secondary" id="edit-profile-btn-dynamic">Изменить профиль</div>
                    <div class="profile-button profile-button-secondary" id="share-profile-btn" style="flex: 0.5;"><i class="fas fa-share-alt"></i></div>
                    <div class="profile-button profile-button-secondary" id="settings-btn" style="flex: 0.5;"><i class="fas fa-cog"></i></div>
                ` : `<div class="profile-button profile-button-primary" id="profile-follow-btn">Подписаться</div>`;

                const profileHTML = `
                    <div class="profile-header">
                        <div class="profile-avatar">${(profile.first_name || 'U').charAt(0).toUpperCase()}</div>
                        <div class="profile-name">${profile.first_name || ''} ${profile.last_name || ''}</div>
                        <div class="profile-username">@${profile.username}</div>
                        <div class="profile-stats">
                            <div class="profile-stat"><div class="stat-value">${stats.following}</div><div class="stat-label">Подписки</div></div>
                            <div class="profile-stat"><div class="stat-value">${stats.followers}</div><div class="stat-label">Подписчики</div></div>
                            <div class="profile-stat"><div class="stat-value">${stats.likes}</div><div class="stat-label">Лайки</div></div>
                        </div>
                        <div class="profile-actions" data-user-id="${profileId}">${profileActionsHTML}</div>
                    </div>
                    <div class="tabs-container" id="${pageId}-tabs">
                        <div class="tab active" data-content="my-videos"><i class="fas fa-th"></i></div>
                        ${isMyProfile ? `
                        <div class="tab" data-content="liked-videos"><i class="far fa-heart"></i></div>
                        <div class="tab" data-content="saved-videos"><i class="far fa-bookmark"></i></div>
                        ` : ''}
                    </div>
                    <div class="content-grid" id="${pageId}-content-grid"></div>`;
                
                page.innerHTML = profileHTML;
                
                if (isMyProfile) {
                    page.querySelector('#edit-profile-btn-dynamic').addEventListener('click', openEditProfile);
                    page.querySelector('#share-profile-btn').addEventListener('click', () => handleShareProfile(profile));
                    page.querySelector('#settings-btn').addEventListener('click', () => tg.showAlert('Раздел настроек в разработке!'));
                } else {
                    updateProfileFollowButton(page, profileId);
                }
                
                page.querySelector(`#${pageId}-tabs`).addEventListener('click', (e) => handleTabClick(e, profileId, pageId));
                handleTabClick({ target: page.querySelector('.tab.active') }, profileId, pageId);
            }

            // --- Навигация ---

            function navigateToPage(pageId, pageData = null) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                const targetPage = document.getElementById(pageId);
                targetPage.classList.add('active');
                
                document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
                const navButton = document.querySelector(`.nav-button[data-page="${pageId}"]`);
                if (navButton) navButton.classList.add('active');
                
                const isHomePage = pageId === 'home-page';

                const bottomNav = document.querySelector('.bottom-nav');
                if (['create-page', 'edit-profile-page', 'video-viewer-page', 'onboarding-page'].includes(pageId)) {
                    bottomNav.style.display = 'none';
                } else {
                    bottomNav.style.display = 'flex';
                }

                if (isHomePage || pageId === 'onboarding-page') { 
                    tg.BackButton.hide(); 
                    if(isHomePage) playCurrentVideo(); 
                } else { 
                    tg.BackButton.show(); 
                    document.querySelectorAll('.video-player').forEach(v => v.pause()); 
                }
                
                // Загрузка контента для страниц, если он еще не загружен
                if (pageId === 'discover-page' && document.getElementById('discover-content').innerHTML === '') applyDiscoverFilters();
                if (pageId === 'profile-page' && (!isInitialized || targetPage.innerHTML.trim() === '')) populateProfile(user.id);
                if (pageId === 'inbox-page' && document.getElementById('inbox-content').querySelector('.empty-state')) populateInbox();

                tg.HapticFeedback.impactOccurred('light');
                updateMainButton(pageId);
            }
            
            function navigateToUserProfile(userId) {
                if (userId === user.id) {
                    navigateToPage('profile-page');
                } else {
                    populateProfile(userId);
                    navigateToPage('user-profile-page');
                }
            }

            // --- Обработчики действий (лайки, подписки и т.д.) ---

            async function handleLike(videoWrapper, videoData, fromDoubleTap = false) {
                if (fromDoubleTap && videoData.isLiked) return;
                
                // Оптимистичное обновление
                videoData.isLiked = !videoData.isLiked;
                videoData.likesCount += videoData.isLiked ? 1 : -1;
                updateLikeButtonUI(videoWrapper.querySelector('.like-btn'), videoData.isLiked, videoData.likesCount);
                
                if (fromDoubleTap && videoData.isLiked) {
                    showDoubleTapLikeAnimation(videoWrapper);
                }

                tg.HapticFeedback.impactOccurred(videoData.isLiked ? 'medium' : 'light');

                // Запрос к API
                try {
                    if (videoData.isLiked) {
                        const { error } = await supabase.from('likes').insert({ video_id: videoData.id, user_id: user.id });
                        if (error) throw error;
                    } else {
                        const { error } = await supabase.from('likes').delete().match({ video_id: videoData.id, user_id: user.id });
                        if (error) throw error;
                    }
                } catch (error) {
                    console.error("Like error:", error);
                    // Откат изменений в случае ошибки
                    videoData.isLiked = !videoData.isLiked;
                    videoData.likesCount += videoData.isLiked ? 1 : -1;
                    updateLikeButtonUI(videoWrapper.querySelector('.like-btn'), videoData.isLiked, videoData.likesCount);
                }
            }
            
            function updateLikeButtonUI(button, isLiked, likesCount) {
                const icon = button.querySelector('i');
                const countEl = button.querySelector('.action-count');
                icon.classList.toggle('fas', isLiked);
                icon.classList.toggle('far', !isLiked);
                icon.classList.toggle('liked', isLiked);
                countEl.textContent = likesCount;
            }

            function showDoubleTapLikeAnimation(videoWrapper) {
                const heart = document.createElement('i');
                heart.className = 'fas fa-heart';
                Object.assign(heart.style, { position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%) scale(0)', color: 'rgba(255, 255, 255, 0.8)', fontSize: '80px', transition: 'all 0.5s ease-out', pointerEvents: 'none', zIndex: 99 });
                videoWrapper.appendChild(heart);
                setTimeout(() => { heart.style.transform = 'translate(-50%, -50%) scale(1)'; heart.style.opacity = '0'; }, 10);
                setTimeout(() => heart.remove(), 500);
            }

            async function handleSave(videoWrapper, videoData) {
                videoData.isSaved = !videoData.isSaved;
                const icon = videoWrapper.querySelector('.save-btn i');
                icon.classList.toggle('fas', videoData.isSaved);
                icon.classList.toggle('far', !videoData.isSaved);
                tg.HapticFeedback.notificationOccurred('success');
                if (videoData.isSaved) {
                    await supabase.from('saves').insert({ video_id: videoData.id, user_id: user.id });
                } else {
                    await supabase.from('saves').delete().match({ video_id: videoData.id, user_id: user.id });
                }
            }
            
            function handleShare(videoData) {
                // ВАЖНО: Замените 'YOUR_BOT_USERNAME' и 'YOUR_APP_NAME' на реальные значения
                const botUsername = 'guid_app_bot'; // Например: 'guid_video_bot'
                const appName = 'guid_app';       // Например: 'guid_app'
                
                if (botUsername === 'YOUR_BOT_USERNAME' || appName === 'YOUR_APP_NAME') {
                    tg.showAlert('Функция "Поделиться" еще не настроена разработчиком.');
                    return;
                }

                const shareText = `Смотри крутое видео от @${videoData.username} в Guid!`;
                const shareUrl = `https://t.me/${botUsername}/${appName}?startapp=video${videoData.id}`;
                const telegramShareUrl = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`;
                
                tg.openTelegramLink(telegramShareUrl);
                tg.HapticFeedback.notificationOccurred('success');
            }

            function handleShareProfile(profile) {
                 // ВАЖНО: Замените 'YOUR_BOT_USERNAME' и 'YOUR_APP_NAME' на реальные значения
                const botUsername = 'guid_app_bot'; // Например: 'guid_video_bot'
                const appName = 'guid_app';       // Например: 'guid_app'

                if (botUsername === 'YOUR_BOT_USERNAME' || appName === 'YOUR_APP_NAME') {
                    tg.showAlert('Функция "Поделиться" еще не настроена разработчиком.');
                    return;
                }

                const shareText = `Подписывайся на @${profile.username} в Guid!`;
                const shareUrl = `https://t.me/${botUsername}/${appName}?startapp=user${profile.id}`;
                const telegramShareUrl = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`;
                
                tg.openTelegramLink(telegramShareUrl);
                tg.HapticFeedback.notificationOccurred('success');
            }

            async function handleFollow(followedId, follow, profilePage = null) {
                // Оптимистичное обновление
                if (profilePage) {
                    const button = profilePage.querySelector('#profile-follow-btn');
                    if(button) {
                        button.textContent = follow ? 'Отписаться' : 'Подписаться';
                        button.classList.toggle('profile-button-primary', !follow);
                        button.classList.toggle('profile-button-secondary', follow);
                    }
                }
                const activeVideoWrapper = document.querySelector('.video-wrapper.active');
                if (activeVideoWrapper && activeVideoWrapper.querySelector(`[data-user-id="${followedId}"]`)) {
                    const avatarDiv = activeVideoWrapper.querySelector('.avatar');
                    const existingBtn = avatarDiv.querySelector('.follow-button');
                    if(follow && !existingBtn) {
                         const followBtn = document.createElement('div');
                         followBtn.className = 'follow-button';
                         followBtn.textContent = '+';
                         avatarDiv.appendChild(followBtn);
                    } else if (!follow && existingBtn) {
                        existingBtn.remove();
                    }
                }

                // Запрос к API
                const action = follow ? 
                    supabase.from('followers').insert({ follower_id: user.id, followed_id: followedId }) :
                    supabase.from('followers').delete().match({ follower_id: user.id, followed_id: followedId });

                const { error } = await action;
                if (error) {
                    console.error("Follow/Unfollow error", error);
                    tg.showAlert('Действие не удалось. Попробуйте снова.');
                    tg.HapticFeedback.notificationOccurred('error');
                    // Откат изменений в случае ошибки
                    if (profilePage) updateProfileFollowButton(profilePage, followedId);
                    if (activeVideoWrapper) updateFollowButton(activeVideoWrapper, followedId);
                } else {
                     tg.HapticFeedback.notificationOccurred('success');
                     // Обновляем UI окончательно
                     if (profilePage) updateProfileFollowButton(profilePage, followedId);
                     if (activeVideoWrapper) updateFollowButton(activeVideoWrapper, followedId);
                }
            }
            
            async function updateFollowButton(videoWrapper, authorId) {
                const avatarDiv = videoWrapper.querySelector('.avatar');
                const existingBtn = avatarDiv.querySelector('.follow-button');
                if (existingBtn) existingBtn.remove();
                if (authorId === user.id) return;
                const { data } = await supabase.from('followers').select().eq('follower_id', user.id).eq('followed_id', authorId);
                if (!data || data.length === 0) {
                    const followBtn = document.createElement('div');
                    followBtn.className = 'follow-button';
                    followBtn.textContent = '+';
                    followBtn.onclick = (e) => { e.stopPropagation(); handleFollow(authorId, true, null); followBtn.remove() };
                    avatarDiv.appendChild(followBtn);
                }
            }

            async function updateProfileFollowButton(page, profileId) {
                const actionsContainer = page.querySelector('.profile-actions');
                const { data: isFollowing } = await supabase.from('followers').select().eq('follower_id', user.id).eq('followed_id', profileId);
                
                if (isFollowing.length > 0) {
                    actionsContainer.innerHTML = `<div class="profile-button profile-button-secondary" id="profile-follow-btn">Отписаться</div>`;
                    page.querySelector('#profile-follow-btn').addEventListener('click', () => handleFollow(profileId, false, page));
                } else {
                    actionsContainer.innerHTML = `<div class="profile-button profile-button-primary" id="profile-follow-btn">Подписаться</div>`;
                    page.querySelector('#profile-follow-btn').addEventListener('click', () => handleFollow(profileId, true, page));
                }
            }

            // --- Логика страниц и компонентов ---
            
            async function openComments(videoId) {
                activeCommentsVideoId = videoId;
                const panel = document.getElementById('comments-panel');
                const list = document.getElementById('comments-list');
                const countEl = document.getElementById('comments-count');
                list.innerHTML = '<div class="loading-indicator"><div class="spinner"></div></div>';
                panel.classList.add('open');
                const { data, error, count } = await supabase.from('comments')
                    .select('*, profiles!comments_user_id_fkey(username, first_name, last_name)', { count: 'exact' })
                    .eq('video_id', videoId)
                    .order('created_at', { ascending: true });
                if (error) {
                    console.error('Error fetching comments:', error);
                    list.innerHTML = 'Не удалось загрузить комментарии.';
                    return;
                }
                countEl.textContent = `${count} комментариев`;
                list.innerHTML = '';
                if (data.length === 0) {
                    list.innerHTML = '<div class="empty-state" style="height: auto;"><div class="empty-state-text">Комментариев пока нет. Будьте первым!</div></div>';
                } else {
                    data.forEach(comment => {
                        const item = document.createElement('div');
                        item.className = 'comment-item';
                        item.innerHTML = `
                            <div class="comment-avatar">${(comment.profiles.username || 'U').charAt(0).toUpperCase()}</div>
                            <div class="comment-content">
                                <div class="username">@${comment.profiles.username}</div>
                                <div class="text">${comment.text}</div>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                }
            }
            function closeComments() {
                document.getElementById('comments-panel').classList.remove('open');
                activeCommentsVideoId = null;
            }
            async function postComment() {
                const input = document.getElementById('comment-input');
                const text = input.value.trim();
                if (!text || !activeCommentsVideoId) return;
                input.disabled = true;
                const { data, error } = await supabase.from('comments').insert({
                    text: text, user_id: user.id, video_id: activeCommentsVideoId
                }).select('*, profiles!comments_user_id_fkey(username)').single();
                
                input.disabled = false;
                if (error) {
                    console.error('Error posting comment:', error);
                    tg.showAlert('Не удалось отправить комментарий.');
                    tg.HapticFeedback.notificationOccurred('error');
                    return;
                }
                input.value = '';
                const list = document.getElementById('comments-list');
                if(list.querySelector('.empty-state')) list.innerHTML = '';
                
                const item = document.createElement('div');
                item.className = 'comment-item';
                item.innerHTML = `
                    <div class="comment-avatar">${(data.profiles.username || 'U').charAt(0).toUpperCase()}</div>
                    <div class="comment-content">
                        <div class="username">@${data.profiles.username}</div>
                        <div class="text">${data.text}</div>
                    </div>`;
                list.appendChild(item);
                list.scrollTop = list.scrollHeight;
                
                // Обновляем счетчик комментариев на видео
                const video = videos.find(v => v.id === activeCommentsVideoId);
                if (video) {
                    video.commentsCount++;
                    const videoWrapper = document.querySelector(`.video-wrapper[data-video-id="${activeCommentsVideoId}"]`);
                    if (videoWrapper) {
                        videoWrapper.querySelector('.comment-btn .action-count').textContent = video.commentsCount;
                    }
                }
            }
            
            async function handleTabClick(e, profileId, pageId) {
                const tab = e.target.closest('.tab');
                if (!tab) return;
                
                document.querySelectorAll(`#${pageId}-tabs .tab`).forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const content = tab.dataset.content;
                const gridId = `${pageId}-content-grid`;
                const grid = document.getElementById(gridId);
                grid.innerHTML = '<div class="loading-indicator"><div class="spinner"></div></div>';
                
                let videosToShow = [];
                let emptyText = "Здесь пока пусто";

                try {
                    if (content === 'my-videos') {
                        const { data, error } = await supabase.from('videos').select(`*, profiles!videos_user_id_fkey(*)`).eq('user_id', profileId).order('created_at', { ascending: false });
                        if (error) throw error;
                        videosToShow = data || [];
                        emptyText = "Вы еще не загрузили ни одного видео.";
                    } else if (content === 'liked-videos') {
                        const { data, error } = await supabase.from('likes').select(`videos!inner(*, profiles!videos_user_id_fkey(*))`).eq('user_id', profileId).order('created_at', { ascending: false });
                        if (error) throw error;
                        videosToShow = data ? data.map(v => v.videos).filter(Boolean) : [];
                        emptyText = "Вам еще не понравилось ни одно видео.";
                    } else if (content === 'saved-videos') {
                        const { data, error } = await supabase.from('saves').select(`videos!inner(*, profiles!videos_user_id_fkey(*))`).eq('user_id', profileId).order('created_at', { ascending: false });
                        if (error) throw error;
                        videosToShow = data ? data.map(v => v.videos).filter(Boolean) : [];
                        emptyText = "Вы еще ничего не сохранили.";
                    }
                } catch (err) {
                    console.error(`Error fetching content for tab ${content}:`, err);
                    grid.innerHTML = `<div class="empty-state"><div class="empty-state-text">Ошибка загрузки</div></div>`;
                    return;
                }
                
                const formattedVideos = videosToShow.map(v => ({
                    ...formatVideoData(v),
                    // Перезаписываем данные, т.к. вложенный запрос может иметь другую структуру
                    id: v.id, url: v.video_url, description: v.description, userId: v.user_id,
                    username: v.profiles?.username || '...',
                }));

                renderGridContent(gridId, formattedVideos, emptyText);
            }
            
            function setupCreatePage() {
                const fileInput = document.getElementById('video-file-input');
                const selectFileBtn = document.getElementById('select-file-btn');
                const previewContainer = document.getElementById('video-preview-container');
                const videoPreview = document.getElementById('video-preview');
                const uploadForm = document.getElementById('upload-form');
                const selectFileContainer = document.getElementById('select-file-button-container');

                selectFileBtn.addEventListener('click', () => fileInput.click());

                fileInput.addEventListener('change', (event) => {
                    selectedFile = event.target.files[0];
                    if (selectedFile) {
                        const fileURL = URL.createObjectURL(selectedFile);
                        videoPreview.src = fileURL;
                        previewContainer.style.display = 'block';
                        uploadForm.style.display = 'block';
                        selectFileContainer.style.display = 'none';
                        updateMainButton('create-page');
                    }
                    event.target.value = null; 
                });
            }

            async function publishVideo() {
                if (!selectedFile) {
                    tg.showAlert('Пожалуйста, выберите файл для загрузки.');
                    return;
                }
                tg.MainButton.showProgress();
                const description = document.getElementById('video-description').value.trim();
                const discipline = document.getElementById('video-discipline').value;
                const style = document.getElementById('video-style').value;
                
                const fileName = `${user.id}/${Date.now()}-${selectedFile.name.replace(/[^a-zA-Z0-9.\-]/g, '_')}`;
                
                const { error: uploadError } = await supabase.storage.from('video').upload(fileName, selectedFile);

                if (uploadError) {
                    console.error('Upload error:', uploadError);
                    tg.showAlert(`Ошибка загрузки файла: ${uploadError.message}.`);
                    tg.HapticFeedback.notificationOccurred('error');
                    tg.MainButton.hideProgress();
                    return;
                }
                
                const { data: publicUrlData } = supabase.storage.from('video').getPublicUrl(fileName);
                
                const { error: dbError } = await supabase.from('videos').insert({
                    user_id: user.id,
                    description: description,
                    video_url: publicUrlData.publicUrl,
                    discipline: discipline,
                    style: style
                });

                tg.MainButton.hideProgress();

                if (dbError) {
                    console.error('Database error:', dbError);
                    tg.showAlert(`Ошибка сохранения данных: ${dbError.message}.`);
                    tg.HapticFeedback.notificationOccurred('error');
                    return;
                }
                
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert('Успех! Ваше видео опубликовано.');
                
                resetCreatePage();
                
                await main(true); // Обновляем ленту
                navigateToPage('home-page');
            }

            function resetCreatePage() {
                document.getElementById('video-preview-container').style.display = 'none';
                document.getElementById('upload-form').style.display = 'none';
                document.getElementById('select-file-button-container').style.display = 'flex';
                document.getElementById('video-description').value = '';
                document.getElementById('video-preview').src = '';
                selectedFile = null;
            }
            
            async function openEditProfile() {
                const { data: profile, error } = await supabase.from('profiles').select().eq('id', user.id).single();
                if (error) {
                    tg.showAlert('Не удалось загрузить данные профиля.');
                    return;
                }
                document.getElementById('edit-first-name').value = profile.first_name || '';
                document.getElementById('edit-last-name').value = profile.last_name || '';
                document.getElementById('edit-username').value = profile.username || '';
                navigateToPage('edit-profile-page');
            }

            async function saveProfile() {
                tg.MainButton.showProgress();

                const updates = {
                    id: user.id,
                    first_name: document.getElementById('edit-first-name').value,
                    last_name: document.getElementById('edit-last-name').value,
                    username: document.getElementById('edit-username').value,
                    updated_at: new Date(),
                };

                const { error } = await supabase.from('profiles').upsert(updates);

                tg.MainButton.hideProgress();

                if (error) {
                    console.error("Profile save error:", error);
                    tg.showAlert('Ошибка сохранения: ' + error.message);
                    tg.HapticFeedback.notificationOccurred('error');
                } else {
                    tg.showAlert('Сохранено! Ваш профиль обновлен.');
                    tg.HapticFeedback.notificationOccurred('success');
                    await populateProfile(user.id);
                    navigateToPage('profile-page');
                }
            }

            async function applyDiscoverFilters() {
                const discoverContent = document.getElementById('discover-content');
                discoverContent.innerHTML = '<div class="loading-indicator"><div class="spinner"></div></div>';
                
                const filters = {
                    discipline: document.getElementById('filter-discipline').value,
                    style: document.getElementById('filter-style').value,
                    city: document.getElementById('filter-city').value,
                    searchQuery: document.querySelector('#discover-page .search-input').value.trim()
                };

                // Удаляем пустые фильтры
                Object.keys(filters).forEach(key => {
                    if (!filters[key]) delete filters[key];
                });

                const filteredVideos = await fetchVideos(filters);
                renderGridContent('discover-content', filteredVideos, "По вашему запросу ничего не найдено.");
                document.getElementById('discover-empty').style.display = filteredVideos.length === 0 ? 'flex' : 'none';
            }

            function populateFilters() {
                const disciplineSelect = document.getElementById('filter-discipline');
                const styleSelect = document.getElementById('filter-style');
                const citySelect = document.getElementById('filter-city');
                const createDisciplineSelect = document.getElementById('video-discipline');
                const createStyleSelect = document.getElementById('video-style');

                const allStyles = [...new Set(Object.values(disciplines).flat())];
                
                Object.keys(disciplines).forEach(d => {
                    disciplineSelect.add(new Option(d, d));
                    createDisciplineSelect.add(new Option(d, d));
                });
                allStyles.forEach(s => styleSelect.add(new Option(s, s)));
                cities.forEach(c => citySelect.add(new Option(c, c)));
                
                const updateStyleOptions = (discipline, targetSelect) => {
                    targetSelect.innerHTML = '';
                    const styles = disciplines[discipline] || [];
                    styles.forEach(s => targetSelect.add(new Option(s, s)));
                };

                createDisciplineSelect.addEventListener('change', (e) => updateStyleOptions(e.target.value, createStyleSelect));
                updateStyleOptions(createDisciplineSelect.value, createStyleSelect); // Initial population
            }

            async function populateInbox() {
                const inboxContent = document.getElementById('inbox-content');
                inboxContent.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><i class="far fa-paper-plane"></i></div><div class="empty-state-text">Функционал чатов находится в разработке.</div></div>`;
            }
            
            // --- Онбординг ---
            let currentOnboardingStep = 1;

            function showOnboardingStep(step) {
                currentOnboardingStep = step;
                document.querySelectorAll('.onboarding-step').forEach(s => s.classList.remove('active'));
                document.querySelector(`#onboarding-step-${step}`).classList.add('active');

                document.querySelectorAll('.progress-step').forEach((p, index) => {
                    p.classList.toggle('active', index < step);
                });
                tg.HapticFeedback.impactOccurred('light');
            }

            function startOnboarding() {
                navigateToPage('onboarding-page');
                showOnboardingStep(1);
            }

            function setupOnboardingListeners() {
                // Step 1: Discipline
                document.querySelectorAll('#onboarding-step-1 .onboarding-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('#onboarding-step-1 .onboarding-option').forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');
                        onboardingData.discipline = option.dataset.discipline;
                        document.getElementById('ob-step1-next').disabled = false;
                    });
                });
                document.getElementById('ob-step1-next').addEventListener('click', () => {
                    populateStyleOptions(onboardingData.discipline);
                    showOnboardingStep(2);
                });

                // Step 2: Style
                document.getElementById('ob-step2-back').addEventListener('click', () => showOnboardingStep(1));
                document.getElementById('ob-step2-next').addEventListener('click', () => {
                    populateCityList();
                    showOnboardingStep(3);
                });

                // Step 3: City
                document.getElementById('ob-step3-back').addEventListener('click', () => showOnboardingStep(2));
                document.getElementById('city-search').addEventListener('input', (e) => populateCityList(e.target.value));
                document.getElementById('ob-step3-finish').addEventListener('click', finishOnboarding);
            }

            function populateStyleOptions(discipline) {
                const container = document.getElementById('style-options');
                container.innerHTML = '';
                const styles = disciplines[discipline] || [];
                styles.forEach(style => {
                    const option = document.createElement('div');
                    option.className = 'onboarding-option';
                    option.textContent = style;
                    option.dataset.style = style;
                    option.addEventListener('click', () => {
                        container.querySelectorAll('.onboarding-option').forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');
                        onboardingData.style = style;
                        document.getElementById('ob-step2-next').disabled = false;
                    });
                    container.appendChild(option);
                });
                onboardingData.style = null;
                document.getElementById('ob-step2-next').disabled = true;
            }

            function populateCityList(filter = '') {
                const container = document.getElementById('city-list');
                container.innerHTML = '';
                const filteredCities = cities.filter(city => city.toLowerCase().includes(filter.toLowerCase()));

                filteredCities.forEach(city => {
                    const item = document.createElement('div');
                    item.className = 'city-item';
                    item.textContent = city;
                    item.addEventListener('click', () => {
                        container.querySelectorAll('.city-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                        onboardingData.city = city;
                        document.getElementById('city-search').value = city;
                        document.getElementById('ob-step3-finish').disabled = false;
                    });
                    container.appendChild(item);
                });
                onboardingData.city = null;
                document.getElementById('ob-step3-finish').disabled = true;
            }
            
            async function finishOnboarding() {
                tg.MainButton.showProgress();
                const { error } = await supabase.from('profiles').update({
                    discipline: onboardingData.discipline,
                    style: onboardingData.style,
                    city: onboardingData.city
                }).eq('id', user.id);

                tg.MainButton.hideProgress();

                if (error) {
                    console.error('Error saving onboarding data:', error);
                    tg.showAlert('Не удалось сохранить данные. Попробуйте снова.');
                    tg.HapticFeedback.notificationOccurred('error');
                } else {
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showAlert('Добро пожаловать!');
                    await main(true); // Перезагружаем данные и переходим на главную
                }
            }

            // --- Управление главной кнопкой и навигацией ---
            function updateMainButton(pageId) {
                tg.MainButton.hide();
                switch (pageId) {
                    case 'edit-profile-page':
                        tg.MainButton.setText('Сохранить изменения').onClick(saveProfile).show();
                        break;
                    case 'create-page':
                        if (selectedFile) {
                            tg.MainButton.setText('Опубликовать видео').onClick(publishVideo).show();
                        }
                        break;
                }
            }

            // --- Инициализация слушателей событий ---
            function initEventListeners() {
                // Навигация
                document.querySelectorAll('.nav-button').forEach(button => {
                    if (button.classList.contains('create-nav-button')) {
                        button.addEventListener('click', () => navigateToPage('create-page'));
                    } else {
                        button.addEventListener('click', () => navigateToPage(button.dataset.page));
                    }
                });

                tg.BackButton.onClick(() => {
                    const activePageId = document.querySelector('.page.active').id;
                    if (['create-page', 'user-profile-page', 'discover-page', 'inbox-page', 'video-viewer-page'].includes(activePageId)) {
                        navigateToPage('home-page');
                    } else if (activePageId === 'edit-profile-page') {
                        navigateToPage('profile-page');
                    } else {
                        navigateToPage('home-page');
                    }
                });
                
                // Свайпы на главной
                let touchStartY = 0;
                const homePage = document.getElementById('home-page');
                homePage.addEventListener('touchstart', (e) => { touchStartY = e.touches[0].clientY; }, { passive: true });
                homePage.addEventListener('touchend', (e) => {
                    const dY = e.changedTouches[0].clientY - touchStartY;
                    if (Math.abs(dY) > 50) navigateVideo(dY > 0 ? -1 : 1);
                }, { passive: true });
                
                // Поиск и фильтры
                document.querySelector('#discover-page .search-input').addEventListener('input', applyDiscoverFilters);
                document.getElementById('filter-discipline').addEventListener('change', applyDiscoverFilters);
                document.getElementById('filter-style').addEventListener('change', applyDiscoverFilters);
                document.getElementById('filter-city').addEventListener('change', applyDiscoverFilters);

                // Комментарии
                document.getElementById('close-comments-btn').addEventListener('click', closeComments);
                document.getElementById('send-comment-btn').addEventListener('click', postComment);
                document.getElementById('comment-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') postComment(); });
                
                // Онбординг
                setupOnboardingListeners();

                // Страница создания
                setupCreatePage();
            }
            
            // --- Старт ---
            initEventListeners();
            main();
        });
    </script>
</body>
</html>
