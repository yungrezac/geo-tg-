<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Guid - Short Video App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #000000);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #aaaaaa);
            --tg-link: var(--tg-theme-link-color, #1c9eff);
            --tg-button: var(--tg-theme-button-color, #1c9eff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #111111);
            --accent-red: #ff3b30;
            --border-radius: 12px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--tg-bg); color: var(--tg-text); height: 100vh; overflow: hidden; position: relative; }
        .page { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: none; overflow-y: auto; padding-bottom: 60px; opacity: 0; transform: scale(0.98); transition: opacity 0.3s ease, transform 0.3s ease; background-color: var(--tg-bg); }
        .page.active { display: block; opacity: 1; transform: scale(1); }
        #home-page { background-color: #000; }
        .video-container { width: 100%; height: 100%; position: relative; overflow: hidden; }
        .video-wrapper { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: none; transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .video-wrapper.active { display: block; z-index: 2; transform: translateY(0); }
        .video-wrapper.next { display: block; z-index: 1; transform: translateY(100%); }
        .video-wrapper.prev { display: block; z-index: 1; transform: translateY(-100%); }
        .video-player { width: 100%; height: 100%; object-fit: cover; background-color: #000; }
        .video-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 40%); pointer-events: none; }
        .video-info { position: absolute; bottom: 60px; left: 15px; z-index: 10; max-width: 70%; color: #fff; }
        .username { font-weight: bold; font-size: 16px; margin-bottom: 5px; cursor: pointer; }
        .description { font-size: 14px; margin-bottom: 10px; line-height: 1.4; }
        .right-sidebar { position: absolute; right: 15px; bottom: 60px; display: flex; flex-direction: column; align-items: center; z-index: 10; color: #fff; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #fff; margin-bottom: 25px; background-color: var(--tg-secondary-bg); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; cursor: pointer; position: relative; }
        .follow-button { position: absolute; bottom: -10px; background-color: var(--accent-red); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; display: flex; align-items: center; justify-content: center; border: 2px solid #000; cursor: pointer; }
        .action-button { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; cursor: pointer; }
        .action-button:last-child { margin-bottom: 0; }
        .action-icon { font-size: 30px; margin-bottom: 5px; transition: transform 0.2s ease; }
        .action-icon.liked { color: var(--accent-red); }
        .action-button:active .action-icon { transform: scale(0.9); }
        .action-count { font-size: 13px; font-weight: 500; }
        .mute-button { position: absolute; top: 66px; right: 15px; z-index: 11; color: #fff; font-size: 24px; cursor: pointer; text-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .header { padding: 15px; font-size: 20px; font-weight: bold; position: sticky; top: 0; background-color: var(--tg-bg); z-index: 10; border-bottom: 1px solid var(--tg-secondary-bg); }
        .search-bar { display: flex; padding: 15px; position: sticky; top: 0; background-color: var(--tg-bg); z-index: 11; }
        .search-input { flex: 1; padding: 12px 15px; border-radius: var(--border-radius); border: none; background-color: var(--tg-secondary-bg); color: var(--tg-text); font-size: 16px; }
        .search-input::placeholder { color: var(--tg-hint); }
        .section-title { font-size: 18px; margin: 20px 15px 15px; font-weight: bold; }
        .profile-header { padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; background-color: var(--tg-secondary-bg); margin-bottom: 15px; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold; border: 3px solid var(--tg-link); }
        .profile-name { font-size: 22px; font-weight: bold; margin-bottom: 5px; }
        .profile-username { font-size: 16px; color: var(--tg-hint); margin-bottom: 15px; }
        .profile-stats { display: flex; justify-content: space-around; width: 100%; margin-bottom: 20px; padding: 0 20px; }
        .profile-stat { text-align: center; }
        .stat-value { font-size: 18px; font-weight: bold; }
        .stat-label { font-size: 12px; color: var(--tg-hint); }
        .profile-actions { display: flex; gap: 10px; width: 100%; padding: 0 15px; margin-bottom: 20px; }
        .profile-button { flex: 1; padding: 12px; border-radius: var(--border-radius); font-size: 14px; font-weight: bold; text-align: center; cursor: pointer; transition: opacity 0.2s ease; }
        .profile-button:active { opacity: 0.8; }
        .profile-button-primary { background-color: var(--tg-button); color: var(--tg-button-text); }
        .profile-button-secondary { background-color: var(--tg-secondary-bg); color: var(--tg-text); }
        .tabs-container { display: flex; border-bottom: 1px solid var(--tg-secondary-bg); position: sticky; top: 0; background-color: var(--tg-bg); z-index: 10; }
        .tab { flex: 1; text-align: center; padding: 15px 0; font-size: 16px; position: relative; cursor: pointer; color: var(--tg-hint); }
        .tab.active { color: var(--tg-text); font-weight: bold; }
        .tab.active::after { content: ''; position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; background-color: var(--tg-link); border-radius: 3px 3px 0 0; }
        .content-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 2px; }
        .grid-item { aspect-ratio: 9/16; background-color: var(--tg-secondary-bg); position: relative; cursor: pointer; }
        .grid-item-thumbnail { width: 100%; height: 100%; object-fit: cover; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 40vh; text-align: center; padding: 20px; color: var(--tg-hint); }
        .empty-state-icon { font-size: 50px; margin-bottom: 20px; }
        .empty-state-text { font-size: 16px; margin-bottom: 15px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background-color: var(--tg-bg); display: flex; justify-content: space-around; align-items: center; z-index: 100; border-top: 1px solid var(--tg-secondary-bg); }
        .nav-button { display: flex; flex-direction: column; align-items: center; color: var(--tg-hint); font-size: 10px; cursor: pointer; padding: 5px; flex: 1; transition: color 0.2s ease; }
        .nav-icon { font-size: 24px; margin-bottom: 3px; }
        .nav-button.active { color: var(--tg-text); font-weight: bold; }
        .create-nav-button { background: var(--tg-button); width: 45px; height: 35px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--tg-button-text); font-size: 22px; }
        .loading-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; display: flex; flex-direction: column; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--tg-secondary-bg); border-radius: 50%; border-top-color: var(--tg-link); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .comments-panel { position: fixed; bottom: 0; left: 0; width: 100%; height: 80vh; background-color: var(--tg-secondary-bg); border-radius: var(--border-radius) var(--border-radius) 0 0; transform: translateY(100%); transition: transform 0.3s ease-out; z-index: 200; display: flex; flex-direction: column; }
        .comments-panel.open { transform: translateY(0); }
        .comments-header { padding: 15px; text-align: center; font-weight: bold; border-bottom: 1px solid var(--tg-hint); position: relative; flex-shrink: 0; }
        .comments-header .close-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px; }
        .comments-list { flex-grow: 1; overflow-y: auto; padding: 10px 15px; }
        .comment-item { display: flex; margin-bottom: 15px; }
        .comment-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--tg-bg); margin-right: 10px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .comment-content .username { font-size: 14px; }
        .comment-content .text { font-size: 14px; line-height: 1.4; }
        .comment-input-container { display: flex; padding: 10px 15px; border-top: 1px solid var(--tg-hint); flex-shrink: 0; }
        .comment-input { flex-grow: 1; background-color: var(--tg-bg); border: none; padding: 10px; border-radius: var(--border-radius); color: var(--tg-text); }
        .comment-send-btn { background: none; border: none; color: var(--tg-link); font-size: 24px; margin-left: 10px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--tg-hint); font-size: 14px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border-radius: var(--border-radius); border: 1px solid var(--tg-secondary-bg); background-color: var(--tg-secondary-bg); color: var(--tg-text); font-size: 16px; }
        #upload-progress { width: 100%; height: 5px; background-color: var(--tg-secondary-bg); border-radius: 5px; margin-top: 10px; display: none; }
        #upload-progress-bar { width: 0; height: 100%; background-color: var(--tg-link); border-radius: 5px; transition: width 0.2s; }
        
        /* Стили для анкеты */
        .onboarding-step { display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; height: 100%; }
        .onboarding-step.active { display: flex; }
        .onboarding-step h2 { font-size: 24px; margin-bottom: 20px; }
        .onboarding-options { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 300px; }
        .onboarding-option { padding: 15px; background-color: var(--tg-secondary-bg); border-radius: var(--border-radius); cursor: pointer; }
        #city-list { max-height: 300px; overflow-y: auto; text-align: left; border: 1px solid var(--tg-secondary-bg); border-radius: var(--border-radius); }
        .city-item { padding: 10px 15px; cursor: pointer; }
        .city-item:hover { background-color: var(--tg-hint); }

        /* Стили для фильтров */
        .filters-container { display: flex; gap: 10px; padding: 10px 15px; background-color: var(--tg-bg); }
        .filter-select { flex: 1; }
    </style>
</head>
<body>
    <!-- Pages -->
    <div id="home-page" class="page active"><div class="video-container" id="video-container"><div class="loading-indicator"><div class="spinner"></div></div></div></div>
    <div id="discover-page" class="page">
        <div class="search-bar"><input type="text" class="search-input" placeholder="Поиск видео и пользователей"></div>
        <div class="filters-container">
            <select id="filter-discipline" class="filter-select form-group"><option value="">Все дисциплины</option></select>
            <select id="filter-style" class="filter-select form-group"><option value="">Все стили</option></select>
            <select id="filter-city" class="filter-select form-group"><option value="">Все города</option></select>
        </div>
        <div id="discover-content" class="content-grid"></div>
        <div id="discover-empty" class="empty-state" style="display: none;"><div class="empty-state-icon"><i class="fas fa-search"></i></div><div class="empty-state-text">Ничего не найдено</div></div>
    </div>
    <div id="create-page" class="page">
        <div class="header">Создать видео</div>
        <input type="file" id="video-file-input" accept="video/*" style="display: none;">
        <div id="upload-form" style="display: none; padding: 15px;">
            <div class="form-group">
                <label for="video-description">Описание</label>
                <textarea id="video-description" rows="3" placeholder="Расскажите о вашем видео..."></textarea>
            </div>
            <div class="form-group">
                <label for="video-discipline">Дисциплина</label>
                <select id="video-discipline"></select>
            </div>
            <div class="form-group">
                <label for="video-style">Стиль</label>
                <select id="video-style"></select>
            </div>
            <div class="profile-button profile-button-primary" id="publish-video-btn" style="display: none;">Опубликовать</div>
            <div id="upload-progress"><div id="upload-progress-bar"></div></div>
        </div>
    </div>
    <div id="inbox-page" class="page"><div class="header">Входящие</div><div id="inbox-content"><div class="empty-state"><div class="empty-state-icon"><i class="far fa-paper-plane"></i></div><div class="empty-state-text">Здесь будут ваши чаты</div></div></div></div>
    <div id="profile-page" class="page"></div>
    <div id="edit-profile-page" class="page">
        <div class="header">Редактировать профиль</div>
        <div style="padding: 15px;">
            <div class="form-group">
                <label for="edit-first-name">Имя</label>
                <input type="text" id="edit-first-name">
            </div>
            <div class="form-group">
                <label for="edit-last-name">Фамилия</label>
                <input type="text" id="edit-last-name">
            </div>
            <div class="form-group">
                <label for="edit-username">Имя пользователя</label>
                <input type="text" id="edit-username">
            </div>
            <div class="profile-button profile-button-primary" id="save-profile-btn" style="display: none;">Сохранить</div>
        </div>
    </div>
    <div id="user-profile-page" class="page"></div>
    <!-- Новая страница для просмотра одного видео -->
    <div id="video-viewer-page" class="page"></div>
    <!-- Новая страница для анкеты -->
    <div id="onboarding-page" class="page">
        <div id="onboarding-step-1" class="onboarding-step active">
            <h2>Чем ты занимаешься?</h2>
            <div class="onboarding-options">
                <div class="onboarding-option" data-discipline="Ролики">Ролики</div>
                <div class="onboarding-option" data-discipline="Скейт">Скейт</div>
                <div class="onboarding-option" data-discipline="BMX">BMX</div>
            </div>
        </div>
        <div id="onboarding-step-2" class="onboarding-step">
            <h2>Выбери свой стиль</h2>
            <div id="style-options" class="onboarding-options"></div>
        </div>
        <div id="onboarding-step-3" class="onboarding-step">
            <h2>Из какого ты города?</h2>
            <input type="text" id="city-search" class="search-input" placeholder="Поиск города..." style="margin-bottom: 15px;">
            <div id="city-list" class="onboarding-options"></div>
        </div>
    </div>

    <!-- Comments Panel -->
    <div id="comments-panel" class="comments-panel">
        <div class="comments-header">
            <span id="comments-count">0 комментариев</span>
            <i class="fas fa-times close-btn" id="close-comments-btn"></i>
        </div>
        <div class="comments-list" id="comments-list"></div>
        <div class="comment-input-container">
            <input type="text" id="comment-input" class="comment-input" placeholder="Ваш комментарий...">
            <button id="send-comment-btn" class="comment-send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav"><div class="nav-button active" data-page="home-page"><div class="nav-icon"><i class="fas fa-home"></i></div><div>Главная</div></div><div class="nav-button" data-page="discover-page"><div class="nav-icon"><i class="fas fa-search"></i></div><div>Интересное</div></div><div class="nav-button create-nav-button" data-page="create-page"><i class="fas fa-plus"></i></div><div class="nav-button" data-page="inbox-page"><div class="nav-icon"><i class="far fa-paper-plane"></i></div><div>Входящие</div></div><div class="nav-button" data-page="profile-page"><div class="nav-icon"><i class="far fa-user"></i></div><div>Профиль</div></div></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            tg.disableVerticalSwipes();
            tg.enableClosingConfirmation();

            tg.onEvent('themeChanged', () => {
                console.log('Тема Telegram изменилась!', tg.themeParams);
            });

            const SUPABASE_URL = 'https://bbtkaiondhlxaxvcvces.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJidGthaW9uZGhseGF4dmN2Y2VzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3NDcyNDUsImV4cCI6MjA2OTMyMzI0NX0.yE-IT4RJoJQC8hAtSCgh9Nh4fX-cADts-DDxuOnVloY';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            const initDataUnsafe = tg.initDataUnsafe || {};
            const user = initDataUnsafe.user || { id: 123456789, first_name: 'Test', last_name: 'User', username: 'testuser' };

            // --- Bot Integration Details ---
            const BOT_USERNAME = 'trixsocialbot';
            // It's good practice to get the app name from the bot info if available,
            // but for now we can hardcode a simple name. This name is part of the URL.
            const MINI_APP_NAME = 'app'; 

            let videos = [];
            let currentVideoIndex = 0;
            let isSwiping = false;
            let activeCommentsVideoId = null;
            let selectedFile = null;
            let isInitialized = false;
            let userProfile = null;
            let pageHistory = ['home-page']; // NEW: For navigation history

            let mainButtonAction = () => {};
            const mainButtonClickHandler = () => {
                if (mainButtonAction) {
                    mainButtonAction();
                }
            };
            tg.MainButton.onClick(mainButtonClickHandler);


            async function upsertUserProfile() {
                const { data, error } = await supabase.from('profiles').upsert({
                    id: user.id,
                    username: user.username,
                    first_name: user.first_name,
                    last_name: user.last_name || null
                }, { onConflict: 'id' }).select().single();
                if (error) console.error('Error upserting profile:', error);
                userProfile = data;
                return data;
            }

            async function fetchVideos(filters = {}) {
                let query = supabase.from('videos').select(`
                    id, video_url, description, user_id,
                    profiles!videos_user_id_fkey( id, username, first_name, last_name, city ),
                    likes ( user_id ),
                    saves ( user_id ),
                    comments ( id )
                `).order('created_at', { ascending: false });

                if (filters.discipline) query = query.eq('discipline', filters.discipline);
                if (filters.style) query = query.eq('style', filters.style);
                if (filters.city) query = query.eq('profiles.city', filters.city);

                const { data, error } = await query;

                if (error) {
                    console.error('Error fetching videos:', error);
                    tg.showAlert(`Не удалось загрузить видео: ${error.message}.`);
                    return [];
                }
                
                return data.map(v => ({
                    id: v.id, url: v.video_url, description: v.description, userId: v.user_id,
                    username: v.profiles?.username || 'unknown', 
                    author: v.profiles,
                    likesCount: v.likes.length, commentsCount: v.comments.length,
                    isLiked: v.likes.some(like => like.user_id === user.id),
                    isSaved: v.saves.some(save => save.user_id === user.id)
                }));
            }
            
            async function fetchProfileStats(userId) {
                const { count: followingCount } = await supabase.from('followers').select('*', { count: 'exact', head: true }).eq('follower_id', userId);
                const { count: followersCount } = await supabase.from('followers').select('*', { count: 'exact', head: true }).eq('followed_id', userId);
                const { data: userVideos, error: videosError } = await supabase.from('videos').select('id').eq('user_id', userId);
                
                if (videosError) {
                    console.error('Error fetching user videos for stats', videosError);
                    return { following: 0, followers: 0, likes: 0 };
                }

                const videoIds = userVideos.map(v => v.id);
                let totalLikes = 0;
                if (videoIds.length > 0) {
                    const { count, error: likesError } = await supabase.from('likes').select('*', { count: 'exact', head: true }).in('video_id', videoIds);
                    if (!likesError) totalLikes = count;
                }
                
                return {
                    following: followingCount || 0,
                    followers: followersCount || 0,
                    likes: totalLikes
                };
            }

            function createVideoElement(videoData, classNames = '') {
                const videoWrapper = document.createElement('div');
                videoWrapper.className = `video-wrapper ${classNames}`;
                videoWrapper.dataset.videoId = videoData.id;

                videoWrapper.innerHTML = `
                    <video class="video-player" src="${videoData.url}" loop playsinline></video>
                    <div class="mute-button"><i class="fas fa-volume-high"></i></div>
                    <div class="video-overlay"></div>
                    <div class="loading-indicator"><div class="spinner"></div></div>
                    <div class="video-info">
                        <div class="username" data-user-id="${videoData.userId}">@${videoData.username}</div>
                        <div class="description">${videoData.description}</div>
                    </div>
                    <div class="right-sidebar">
                        <div class="avatar" data-user-id="${videoData.userId}">${(videoData.username || 'U').charAt(0).toUpperCase()}</div>
                        <div class="action-button like-btn">
                            <i class="action-icon ${videoData.isLiked ? 'fas liked' : 'far'} fa-heart"></i>
                            <div class="action-count">${videoData.likesCount}</div>
                        </div>
                        <div class="action-button comment-btn">
                            <i class="action-icon far fa-comment-dots"></i>
                            <div class="action-count">${videoData.commentsCount}</div>
                        </div>
                        <div class="action-button save-btn">
                            <i class="action-icon ${videoData.isSaved ? 'fas' : 'far'} fa-bookmark"></i>
                        </div>
                        <div class="action-button share-btn">
                            <i class="action-icon fas fa-share"></i>
                        </div>
                    </div>`;
                
                const videoPlayer = videoWrapper.querySelector('.video-player');
                const muteButton = videoWrapper.querySelector('.mute-button');

                muteButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    videoPlayer.muted = !videoPlayer.muted;
                    muteButton.querySelector('i').className = videoPlayer.muted ? 'fas fa-volume-mute' : 'fas fa-volume-high';
                });

                videoWrapper.querySelector('.like-btn').addEventListener('click', (e) => { e.stopPropagation(); handleLike(videoWrapper, videoData); });
                videoWrapper.querySelector('.save-btn').addEventListener('click', (e) => { e.stopPropagation(); handleSave(videoWrapper, videoData); });
                videoWrapper.querySelector('.comment-btn').addEventListener('click', (e) => { e.stopPropagation(); openComments(videoData.id); });
                videoWrapper.querySelector('.share-btn').addEventListener('click', (e) => { e.stopPropagation(); handleShare(videoData); });
                videoWrapper.querySelector('.username').addEventListener('click', (e) => { e.stopPropagation(); navigateToUserProfile(videoData.userId); });
                videoWrapper.querySelector('.avatar').addEventListener('click', (e) => { e.stopPropagation(); navigateToUserProfile(videoData.userId); });

                let clickTimer = null;
                videoWrapper.addEventListener('click', (e) => {
                    if (e.target.closest('.video-info, .right-sidebar, .mute-button')) {
                        return;
                    }
                    
                    if (clickTimer === null) {
                        clickTimer = setTimeout(() => {
                            clickTimer = null;
                            if (videoPlayer) {
                                if (videoPlayer.paused) {
                                    videoPlayer.play();
                                } else {
                                    videoPlayer.pause();
                                }
                            }
                        }, 300);
                    } else {
                        clearTimeout(clickTimer);
                        clickTimer = null;
                        handleLike(videoWrapper, videoData, true);
                    }
                });
                
                updateFollowButton(videoWrapper, videoData.userId);
                return videoWrapper;
            }
            
            function renderVideoFeed() {
                const videoContainer = document.getElementById('video-container');
                videoContainer.innerHTML = '<div class="loading-indicator"><div class="spinner"></div></div>';
                if (videos.length === 0) {
                    videoContainer.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-video-slash"></i></div><div class="empty-state-text">Пока нет видео. Загрузите первое!</div></div>`;
                    return;
                }
                videoContainer.innerHTML = '';
                const prevIndex = (currentVideoIndex - 1 + videos.length) % videos.length;
                const nextIndex = (currentVideoIndex + 1) % videos.length;
                videoContainer.append(createVideoElement(videos[prevIndex], 'prev'), createVideoElement(videos[currentVideoIndex], 'active'), createVideoElement(videos[nextIndex], 'next'));
                playCurrentVideo();
            }

            function playCurrentVideo() {
                document.querySelectorAll('.video-player').forEach(v => {
                    v.pause();
                });

                const activeVideoWrapper = document.querySelector('.video-wrapper.active');
                if (!activeVideoWrapper) return;

                const activeVideo = activeVideoWrapper.querySelector('.video-player');
                const loadingIndicator = activeVideoWrapper.querySelector('.loading-indicator');
                const muteButtonIcon = activeVideoWrapper.querySelector('.mute-button i');

                if (activeVideo) {
                    activeVideo.currentTime = 0;
                    activeVideo.muted = false;
                    if (muteButtonIcon) muteButtonIcon.className = 'fas fa-volume-high';
                    
                    loadingIndicator.style.display = 'flex';

                    const playPromise = activeVideo.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.error("Autoplay with sound failed, trying muted:", error);
                            activeVideo.muted = true;
                            if (muteButtonIcon) muteButtonIcon.className = 'fas fa-volume-mute';
                            activeVideo.play();
                        });
                    }

                    activeVideo.oncanplaythrough = () => {
                        loadingIndicator.style.display = 'none';
                    };
                }
            }
            
            function navigateVideo(direction) {
                if (isSwiping || videos.length <= 1) return;
                isSwiping = true;
                currentVideoIndex = (currentVideoIndex + direction + videos.length) % videos.length;
                renderVideoFeed(); 
                tg.HapticFeedback.impactOccurred('light');
                setTimeout(() => { isSwiping = false; }, 400);
            }

            function createGridItem(video) {
                const item = document.createElement('div');
                item.className = 'grid-item';
                item.innerHTML = `<video muted playsinline class="grid-item-thumbnail" src="${video.url}#t=0.5" preload="metadata"></video>`;
                item.addEventListener('click', () => {
                   openVideoViewer(video);
                });
                return item;
            }

            function openVideoViewer(videoData) {
                const viewerPage = document.getElementById('video-viewer-page');
                viewerPage.innerHTML = ''; // Очищаем предыдущее видео
                const videoWrapper = createVideoElement(videoData, 'active');
                viewerPage.appendChild(videoWrapper);
                navigateToPage('video-viewer-page');
                const videoPlayer = videoWrapper.querySelector('.video-player');
                if (videoPlayer) {
                    videoPlayer.play().catch(e => console.error("Play error in viewer:", e));
                }
            }

            function renderGridContent(containerId, data, emptyText = "Здесь пока пусто") {
                const grid = document.getElementById(containerId);
                grid.innerHTML = '';
                if (!data || data.length === 0) {
                    grid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><div class="empty-state-icon"><i class="fas fa-video-slash"></i></div><div class="empty-state-text">${emptyText}</div></div>`;
                    return;
                }
                data.forEach(video => grid.appendChild(createGridItem(video)));
            }
            
            async function populateProfile(profileId) {
                const isMyProfile = profileId === user.id;
                const pageId = isMyProfile ? 'profile-page' : 'user-profile-page';
                const page = document.getElementById(pageId);
                page.innerHTML = '<div class="loading-indicator"><div class="spinner"></div></div>';
                
                const { data: profile, error } = await supabase.from('profiles').select().eq('id', profileId).single();
                if (error) { console.error('Error fetching profile', error); page.innerHTML = 'Не удалось загрузить профиль.'; return; }

                const stats = await fetchProfileStats(profileId);
                
                const profileActionsHTML = isMyProfile ? `
                    <div class="profile-button profile-button-secondary" id="edit-profile-btn-dynamic">Изменить профиль</div>
                    <div class="profile-button profile-button-secondary" id="share-profile-btn" style="flex: 0.5;"><i class="fas fa-share-alt"></i></div>
                    <div class="profile-button profile-button-secondary" id="settings-btn" style="flex: 0.5;"><i class="fas fa-cog"></i></div>
                ` : '';

                const profileHTML = `
                    <div class="profile-header">
                        <div class="profile-avatar">${(profile.first_name || 'U').charAt(0).toUpperCase()}</div>
                        <div class="profile-name">${profile.first_name || ''} ${profile.last_name || ''}</div>
                        <div class="profile-username">@${profile.username}</div>
                        <div class="profile-stats">
                            <div class="profile-stat"><div class="stat-value">${stats.following}</div><div class="stat-label">Подписки</div></div>
                            <div class="profile-stat"><div class="stat-value">${stats.followers}</div><div class="stat-label">Подписчики</div></div>
                            <div class="profile-stat"><div class="stat-value">${stats.likes}</div><div class="stat-label">Лайки</div></div>
                        </div>
                        <div class="profile-actions" data-user-id="${profileId}">${profileActionsHTML}</div>
                    </div>
                    <div class="tabs-container" id="${pageId}-tabs">
                        <div class="tab active" data-content="my-videos"><i class="fas fa-th"></i></div>
                        ${isMyProfile ? `
                        <div class="tab" data-content="liked-videos"><i class="far fa-heart"></i></div>
                        <div class="tab" data-content="saved-videos"><i class="far fa-bookmark"></i></div>
                        ` : ''}
                    </div>
                    <div class="content-grid" id="${pageId}-content-grid"></div>`;
                
                page.innerHTML = profileHTML;
                
                const actionsContainer = page.querySelector('.profile-actions');
                if (isMyProfile) {
                    page.querySelector('#edit-profile-btn-dynamic').addEventListener('click', openEditProfile);
                    page.querySelector('#share-profile-btn').addEventListener('click', () => handleShareProfile(profile));
                    page.querySelector('#settings-btn').addEventListener('click', () => tg.showAlert('Раздел настроек в разработке!'));
                } else {
                    updateProfileFollowButton(page, profileId);
                }
                
                page.querySelector(`#${pageId}-tabs`).addEventListener('click', (e) => handleTabClick(e, profileId, pageId));
                handleTabClick({ target: page.querySelector('.tab.active') }, profileId, pageId);
            }

            async function updateProfileFollowButton(page, profileId) {
                const actionsContainer = page.querySelector('.profile-actions');
                const { data: isFollowing } = await supabase.from('followers').select().eq('follower_id', user.id).eq('followed_id', profileId);
                if (isFollowing.length > 0) {
                    actionsContainer.innerHTML = `<div class="profile-button profile-button-secondary" id="profile-follow-btn">Отписаться</div>`;
                    page.querySelector('#profile-follow-btn').addEventListener('click', () => handleFollow(profileId, false, page));
                } else {
                    actionsContainer.innerHTML = `<div class="profile-button profile-button-primary" id="profile-follow-btn">Подписаться</div>`;
                    page.querySelector('#profile-follow-btn').addEventListener('click', () => handleFollow(profileId, true, page));
                }
            }
            
            // REPLACED: Old navigation logic is removed and replaced with the functions below.

            /**
             * Handles all visual updates when changing a page.
             * @param {string} pageId The ID of the page to show.
             */
            function showPage(pageId) {
                // Update active page class
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');

                // Update active nav button class
                document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
                const navButton = document.querySelector(`.nav-button[data-page="${pageId}"]`);
                if (navButton) navButton.classList.add('active');
                
                // Manage bottom nav visibility
                const bottomNav = document.querySelector('.bottom-nav');
                if (['create-page', 'edit-profile-page', 'video-viewer-page'].includes(pageId)) {
                    bottomNav.style.display = 'none';
                } else {
                    bottomNav.style.display = 'flex';
                }

                // Manage Back Button visibility based on page
                const mainTabPages = ['home-page', 'discover-page', 'inbox-page', 'profile-page'];
                if (mainTabPages.includes(pageId)) {
                    tg.BackButton.hide();
                } else {
                    tg.BackButton.show();
                }
                
                // Lazy load content for pages
                if (pageId === 'discover-page' && document.getElementById('discover-content').innerHTML === '') populateDiscoverPage();
                if (pageId === 'profile-page' && (!isInitialized || document.getElementById(pageId).innerHTML.trim() === '')) populateProfile(user.id);
                if (pageId === 'inbox-page' && document.getElementById('inbox-content').querySelector('.empty-state')) populateInbox();

                // Manage Main Button
                tg.MainButton.hide();
                mainButtonAction = () => {};
                if (pageId === 'edit-profile-page') {
                    tg.MainButton.setText('Сохранить изменения');
                    mainButtonAction = () => document.getElementById('save-profile-btn').click();
                    tg.MainButton.show();
                } else if (pageId === 'create-page' && selectedFile) {
                    tg.MainButton.setText('Опубликовать видео');
                    mainButtonAction = () => document.getElementById('publish-video-btn').click();
                    tg.MainButton.show();
                }
                
                // Manage video playback
                if (pageId === 'home-page') { 
                    playCurrentVideo(); 
                } else { 
                    document.querySelectorAll('.video-player').forEach(v => v.pause()); 
                }
            }

            /**
             * Navigates forward to a new page and updates history.
             * @param {string} pageId The ID of the page to navigate to.
             */
            function navigateToPage(pageId) {
                const currentPageId = pageHistory[pageHistory.length - 1];
                if (pageId === currentPageId) return;

                pageHistory.push(pageId);
                showPage(pageId);
                tg.HapticFeedback.impactOccurred('light');
            }
            
            function navigateToUserProfile(userId) {
                if (userId === user.id) {
                    navigateToPage('profile-page');
                } else {
                    populateProfile(userId);
                    navigateToPage('user-profile-page');
                }
            }

            async function handleLike(videoWrapper, videoData, fromDoubleTap = false) {
                if (fromDoubleTap && videoData.isLiked) return;
                videoData.isLiked = !videoData.isLiked;
                videoData.likesCount += videoData.isLiked ? 1 : -1;
                const button = videoWrapper.querySelector('.like-btn');
                const icon = button.querySelector('i');
                const countEl = button.querySelector('.action-count');
                icon.classList.toggle('fas', videoData.isLiked);
                icon.classList.toggle('far', !videoData.isLiked);
                icon.classList.toggle('liked', videoData.isLiked);
                countEl.textContent = videoData.likesCount;
                if (fromDoubleTap && videoData.isLiked) {
                    const heart = document.createElement('i');
                    heart.className = 'fas fa-heart';
                    Object.assign(heart.style, { position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%) scale(0)', color: 'rgba(255, 255, 255, 0.8)', fontSize: '80px', transition: 'all 0.5s ease-out', pointerEvents: 'none', zIndex: 99 });
                    videoWrapper.appendChild(heart);
                    setTimeout(() => { heart.style.transform = 'translate(-50%, -50%) scale(1)'; heart.style.opacity = '0'; }, 10);
                    setTimeout(() => heart.remove(), 500);
                }
                tg.HapticFeedback.impactOccurred(videoData.isLiked ? 'medium' : 'light');
                if (videoData.isLiked) {
                    await supabase.from('likes').insert({ video_id: videoData.id, user_id: user.id });
                } else {
                    await supabase.from('likes').delete().match({ video_id: videoData.id, user_id: user.id });
                }
            }
            async function handleSave(videoWrapper, videoData) {
                videoData.isSaved = !videoData.isSaved;
                const icon = videoWrapper.querySelector('.save-btn i');
                icon.classList.toggle('fas', videoData.isSaved);
                icon.classList.toggle('far', !videoData.isSaved);
                tg.HapticFeedback.notificationOccurred('success');
                if (videoData.isSaved) {
                    await supabase.from('saves').insert({ video_id: videoData.id, user_id: user.id });
                } else {
                    await supabase.from('saves').delete().match({ video_id: videoData.id, user_id: user.id });
                }
            }
            
            function handleShare(videoData) {
                const shareText = `Смотри крутое видео от @${videoData.username} в Guid!`;
                // UPDATED: Using the correct bot username and app name for the share URL
                const shareUrl = `https://t.me/${BOT_USERNAME}/${MINI_APP_NAME}?startapp=video${videoData.id}`;
                
                const telegramShareUrl = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`;
                
                tg.openTelegramLink(telegramShareUrl);
                tg.HapticFeedback.notificationOccurred('success');
            }

            function handleShareProfile(profile) {
                const shareText = `Подписывайся на @${profile.username} в Guid!`;
                // UPDATED: Using the correct bot username and app name for the share URL
                const shareUrl = `https://t.me/${BOT_USERNAME}/${MINI_APP_NAME}?startapp=user${profile.id}`;
                
                const telegramShareUrl = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`;
                
                tg.openTelegramLink(telegramShareUrl);
                tg.HapticFeedback.notificationOccurred('success');
            }

            async function openComments(videoId) {
                activeCommentsVideoId = videoId;
                const panel = document.getElementById('comments-panel');
                const list = document.getElementById('comments-list');
                const countEl = document.getElementById('comments-count');
                list.innerHTML = '<div class="loading-indicator"><div class="spinner"></div></div>';
                panel.classList.add('open');
                const { data, error, count } = await supabase.from('comments')
                    .select('*, profiles!comments_user_id_fkey(username, first_name, last_name)', { count: 'exact' })
                    .eq('video_id', videoId)
                    .order('created_at', { ascending: true });
                if (error) {
                    console.error('Error fetching comments:', error);
                    list.innerHTML = 'Не удалось загрузить комментарии.';
                    return;
                }
                countEl.textContent = `${count} комментариев`;
                list.innerHTML = '';
                if (data.length === 0) {
                    list.innerHTML = '<div class="empty-state" style="height: auto;"><div class="empty-state-text">Комментариев пока нет. Будьте первым!</div></div>';
                } else {
                    data.forEach(comment => {
                        const item = document.createElement('div');
                        item.className = 'comment-item';
                        item.innerHTML = `
                            <div class="comment-avatar">${(comment.profiles.username || 'U').charAt(0).toUpperCase()}</div>
                            <div class="comment-content">
                                <div class="username">@${comment.profiles.username}</div>
                                <div class="text">${comment.text}</div>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                }
            }
            function closeComments() {
                document.getElementById('comments-panel').classList.remove('open');
                activeCommentsVideoId = null;
            }
            async function postComment() {
                const input = document.getElementById('comment-input');
                const text = input.value.trim();
                if (!text || !activeCommentsVideoId) return;
                const { data, error } = await supabase.from('comments').insert({
                    text: text, user_id: user.id, video_id: activeCommentsVideoId
                }).select('*, profiles!comments_user_id_fkey(username)').single();
                if (error) {
                    console.error('Error posting comment:', error);
                    tg.showAlert('Не удалось отправить комментарий.');
                    tg.HapticFeedback.notificationOccurred('error');
                    return;
                }
                input.value = '';
                const list = document.getElementById('comments-list');
                const item = document.createElement('div');
                item.className = 'comment-item';
                item.innerHTML = `
                    <div class="comment-avatar">${(data.profiles.username || 'U').charAt(0).toUpperCase()}</div>
                    <div class="comment-content">
                        <div class="username">@${data.profiles.username}</div>
                        <div class="text">${data.text}</div>
                    </div>`;
                if(list.querySelector('.empty-state')) list.innerHTML = '';
                list.appendChild(item);
                list.scrollTop = list.scrollHeight;
                const video = videos.find(v => v.id === activeCommentsVideoId);
                if (video) {
                    video.commentsCount++;
                    const videoWrapper = document.querySelector(`.video-wrapper[data-video-id="${activeCommentsVideoId}"]`);
                    if (videoWrapper) {
                        videoWrapper.querySelector('.comment-btn .action-count').textContent = video.commentsCount;
                    }
                }
            }
            async function handleFollow(followedId, follow = true, profilePage = null) {
                const action = follow ? 
                    supabase.from('followers').insert({ follower_id: user.id, followed_id: followedId }) :
                    supabase.from('followers').delete().match({ follower_id: user.id, followed_id: followedId });

                const { error } = await action;
                if (error) {
                    console.error("Follow/Unfollow error", error);
                    tg.showAlert('Действие не удалось. Попробуйте снова.');
                    tg.HapticFeedback.notificationOccurred('error');
                    return;
                }
                tg.HapticFeedback.notificationOccurred('success');
                const activeVideoWrapper = document.querySelector('.video-wrapper.active');
                if (activeVideoWrapper && activeVideoWrapper.querySelector(`[data-user-id="${followedId}"]`)) {
                    await updateFollowButton(activeVideoWrapper, followedId);
                }
                if (profilePage) {
                    await updateProfileFollowButton(profilePage, followedId);
                }
            }

            async function updateFollowButton(videoWrapper, authorId) {
                const avatarDiv = videoWrapper.querySelector('.avatar');
                const existingBtn = avatarDiv.querySelector('.follow-button');
                if (existingBtn) existingBtn.remove();
                if (authorId === user.id) return;
                const { data } = await supabase.from('followers').select().eq('follower_id', user.id).eq('followed_id', authorId);
                if (!data || data.length === 0) {
                    const followBtn = document.createElement('div');
                    followBtn.className = 'follow-button';
                    followBtn.textContent = '+';
                    followBtn.onclick = (e) => { e.stopPropagation(); handleFollow(authorId, true); };
                    avatarDiv.appendChild(followBtn);
                }
            }
            
            async function handleTabClick(e, profileId, pageId) {
                const tab = e.target.closest('.tab');
                if (!tab) return;
                
                document.querySelectorAll(`#${pageId}-tabs .tab`).forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const content = tab.dataset.content;
                const gridId = `${pageId}-content-grid`;
                const grid = document.getElementById(gridId);
                grid.innerHTML = '<div class="loading-indicator"><div class="spinner"></div></div>';
                
                let videosToShow = [];
                let emptyText = "Здесь пока пусто";

                if (content === 'my-videos') {
                    const { data, error } = await supabase
                        .from('videos')
                        .select('*, profiles!videos_user_id_fkey(*)')
                        .eq('user_id', profileId)
                        .order('created_at', { ascending: false });
                    if (error) console.error("Error fetching user videos:", error);
                    videosToShow = data || [];
                    emptyText = "Вы еще не загрузили ни одного видео.";
                } else if (content === 'liked-videos') {
                    const { data, error } = await supabase.from('likes').select(`videos!inner(*, profiles!videos_user_id_fkey(*))`).eq('user_id', profileId).order('created_at', { ascending: false });
                    if (error) console.error("Error fetching liked videos:", error);
                    videosToShow = data ? data.map(v => v.videos).filter(Boolean) : [];
                    emptyText = "Вам еще не понравилось ни одно видео.";
                } else if (content === 'saved-videos') {
                     const { data, error } = await supabase.from('saves').select(`videos!inner(*, profiles!videos_user_id_fkey(*))`).eq('user_id', profileId).order('created_at', { ascending: false });
                     if (error) console.error("Error fetching saved videos:", error);
                    videosToShow = data ? data.map(v => v.videos).filter(Boolean) : [];
                    emptyText = "Вы еще ничего не сохранили.";
                }
                
                const formattedVideos = videosToShow.map(v => ({
                    id: v.id, url: v.video_url, description: v.description, userId: v.user_id,
                    username: v.profiles?.username || '...',
                }));

                renderGridContent(gridId, formattedVideos, emptyText);
            }
            
            document.getElementById('video-file-input').addEventListener('change', (event) => {
                selectedFile = event.target.files[0];
                if (selectedFile) {
                    navigateToPage('create-page');
                }
                event.target.value = null; 
            });

            document.getElementById('publish-video-btn').addEventListener('click', async () => {
                if (!selectedFile) {
                    tg.showAlert('Пожалуйста, выберите файл для загрузки.');
                    return;
                }
                tg.MainButton.showProgress();
                const description = document.getElementById('video-description').value.trim();
                const discipline = document.getElementById('video-discipline').value;
                const style = document.getElementById('video-style').value;
                
                const fileName = `${user.id}/${Date.now()}-${selectedFile.name}`;
                
                const { error: uploadError } = await supabase.storage
                    .from('video')
                    .upload(fileName, selectedFile);

                if (uploadError) {
                    console.error('Upload error:', uploadError);
                    tg.showAlert(`Ошибка загрузки файла: ${uploadError.message}.`);
                    tg.HapticFeedback.notificationOccurred('error');
                    tg.MainButton.hideProgress();
                    return;
                }
                
                const { data: publicUrlData } = supabase.storage.from('video').getPublicUrl(fileName);
                
                const { error: dbError } = await supabase.from('videos').insert({
                    user_id: user.id,
                    description: description,
                    video_url: publicUrlData.publicUrl,
                    discipline: discipline,
                    style: style
                });

                tg.MainButton.hideProgress();

                if (dbError) {
                    console.error('Database error:', dbError);
                    tg.showAlert(`Ошибка сохранения данных: ${dbError.message}.`);
                    tg.HapticFeedback.notificationOccurred('error');
                    return;
                }
                
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert('Успех! Ваше видео опубликовано.');
                
                document.getElementById('upload-form').style.display = 'none';
                document.getElementById('video-description').value = '';
                selectedFile = null;
                
                await main(true);
                navigateToPage('home-page');
            });
            
            async function openEditProfile() {
                const { data: profile, error } = await supabase.from('profiles').select().eq('id', user.id).single();
                if (error) {
                    tg.showAlert('Не удалось загрузить данные профиля.');
                    return;
                }
                document.getElementById('edit-first-name').value = profile.first_name || '';
                document.getElementById('edit-last-name').value = profile.last_name || '';
                document.getElementById('edit-username').value = profile.username || '';
                navigateToPage('edit-profile-page');
            }

            document.getElementById('save-profile-btn').addEventListener('click', async () => {
                tg.MainButton.showProgress();

                const updates = {
                    id: user.id,
                    first_name: document.getElementById('edit-first-name').value,
                    last_name: document.getElementById('edit-last-name').value,
                    username: document.getElementById('edit-username').value,
                    updated_at: new Date(),
                };

                const { error } = await supabase.from('profiles').upsert(updates);

                tg.MainButton.hideProgress();

                if (error) {
                    console.error("Profile save error:", error);
                    tg.showAlert('Ошибка сохранения: ' + error.message);
                    tg.HapticFeedback.notificationOccurred('error');
                } else {
                    tg.showAlert('Сохранено! Ваш профиль обновлен.');
                    tg.HapticFeedback.notificationOccurred('success');
                    await populateProfile(user.id);
                    navigateToPage('profile-page');
                }
            });

            async function populateDiscoverPage() {
                const discoverContent = document.getElementById('discover-content');
                discoverContent.innerHTML = '<div class="loading-indicator"><div class="spinner"></div></div>';
                const allVideos = await fetchVideos();
                renderGridContent('discover-content', allVideos);
            }

            async function populateInbox() {
                const inboxContent = document.getElementById('inbox-content');
                inboxContent.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><i class="far fa-paper-plane"></i></div><div class="empty-state-text">Функционал чатов находится в разработке.</div></div>`;
            }
            
            document.querySelectorAll('.nav-button').forEach(button => {
                if (button.classList.contains('create-nav-button')) {
                    button.addEventListener('click', () => {
                        document.getElementById('video-file-input').click();
                    });
                } else {
                    button.addEventListener('click', () => navigateToPage(button.dataset.page));
                }
            });

            // REPLACED: Old BackButton handler is replaced with a new one that uses history.
            tg.BackButton.onClick(() => {
                // Ensure there's a page to go back to
                if (pageHistory.length > 1) {
                    pageHistory.pop(); // Remove the current page
                    const previousPageId = pageHistory[pageHistory.length - 1];
                    showPage(previousPageId); // Show the previous page without adding to history
                }
            });
            
            let touchStartY = 0;
            const homePage = document.getElementById('home-page');

            homePage.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
            }, { passive: true });

            homePage.addEventListener('touchend', (e) => {
                const dY = e.changedTouches[0].clientY - touchStartY;
                if (Math.abs(dY) > 50) {
                    navigateVideo(dY > 0 ? -1 : 1);
                }
            }, { passive: true });
            
            document.querySelector('.search-input').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const filteredVideos = videos.filter(v => v.description.toLowerCase().includes(query) || v.username.toLowerCase().includes(query));
                document.getElementById('discover-empty').style.display = filteredVideos.length === 0 && query.length > 0 ? 'flex' : 'none';
                renderGridContent('discover-content', filteredVideos);
            });
            
            document.getElementById('close-comments-btn').addEventListener('click', closeComments);
            document.getElementById('send-comment-btn').addEventListener('click', postComment);
            document.getElementById('comment-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') postComment(); });
            
            async function main(forceRefresh = false) {
                userProfile = await upsertUserProfile();

                if (!userProfile.discipline) {
                    // Assuming startOnboarding function exists somewhere
                    // startOnboarding(); 
                    // For now, let's proceed to the main app if it doesn't exist.
                     if (forceRefresh || videos.length === 0) {
                        videos = await fetchVideos();
                    }
                    renderVideoFeed();
                    populateProfile(user.id);
                    isInitialized = true;

                } else {
                    if (forceRefresh || videos.length === 0) {
                        videos = await fetchVideos();
                    }
                    renderVideoFeed();
                    populateProfile(user.id);
                    isInitialized = true;
                }
                 // Initial page setup
                showPage(pageHistory[pageHistory.length-1]);
            }

            main();

            setInterval(() => {
                const activeVideoWrapper = document.querySelector('.video-wrapper.active');
                if (!activeVideoWrapper) return;

                const videoPlayer = activeVideoWrapper.querySelector('.video-player');
                
                if (videoPlayer && videoPlayer.muted) {
                    videoPlayer.muted = false;
                    
                    const muteButton = activeVideoWrapper.querySelector('.mute-button');
                    if (muteButton) {
                         muteButton.querySelector('i').className = 'fas fa-volume-high';
                    }
                }
            }, 500); 
        });
    </script>
</body>
</html>
