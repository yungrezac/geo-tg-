<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Guid - Short Video App</title>
    <!-- Подключение Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Подключение Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Подключение иконок Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #000000);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #aaaaaa);
            --tg-link: var(--tg-theme-link-color, #1c9eff);
            --tg-button: var(--tg-theme-button-color, #1c9eff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #111111);
            --accent-red: #ff3b30;
            --border-radius: 12px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--tg-bg); color: var(--tg-text); height: 100vh; overflow: hidden; position: relative; }
        .page { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: none; overflow-y: auto; padding-bottom: 60px; opacity: 0; transform: scale(0.98); transition: opacity 0.3s ease, transform 0.3s ease; background-color: var(--tg-bg); }
        .page.active { display: block; opacity: 1; transform: scale(1); }
        #home-page { background-color: #000; }
        .video-container { width: 100%; height: 100%; position: relative; overflow: hidden; }
        .video-wrapper { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: none; transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .video-wrapper.active { display: block; z-index: 2; transform: translateY(0); }
        .video-wrapper.next { display: block; z-index: 1; transform: translateY(100%); }
        .video-wrapper.prev { display: block; z-index: 1; transform: translateY(-100%); }
        .video-player { width: 100%; height: 100%; object-fit: cover; background-color: #000; }
        .video-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 40%); pointer-events: none; }
        .video-info { position: absolute; bottom: 75px; left: 15px; z-index: 10; max-width: 70%; color: #fff; }
        .username { font-weight: bold; font-size: 16px; margin-bottom: 5px; cursor: pointer; }
        .description { font-size: 14px; margin-bottom: 10px; line-height: 1.4; }
        .right-sidebar { position: absolute; right: 15px; bottom: 80px; display: flex; flex-direction: column; align-items: center; z-index: 10; color: #fff; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #fff; margin-bottom: 25px; background-color: var(--tg-secondary-bg); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; cursor: pointer; position: relative; background-size: cover; background-position: center; }
        .follow-button { position: absolute; bottom: -10px; background-color: var(--accent-red); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; display: flex; align-items: center; justify-content: center; border: 2px solid #000; cursor: pointer; }
        .action-button { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; cursor: pointer; }
        .action-icon { font-size: 30px; margin-bottom: 5px; transition: transform 0.2s ease; }
        .action-icon.liked { color: var(--accent-red); }
        .action-button:active .action-icon { transform: scale(0.9); }
        .action-count { font-size: 13px; font-weight: 500; }
        .header { padding: 15px; font-size: 20px; font-weight: bold; position: sticky; top: 0; background-color: var(--tg-bg); z-index: 10; border-bottom: 1px solid var(--tg-secondary-bg); }
        .profile-header { padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; background-color: var(--tg-secondary-bg); margin-bottom: 15px; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold; border: 3px solid var(--tg-link); background-size: cover; background-position: center; position: relative; }
        .profile-avatar-edit-overlay { position: absolute; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); color: white; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
        .profile-avatar:hover .profile-avatar-edit-overlay { opacity: 1; }
        .profile-name { font-size: 22px; font-weight: bold; margin-bottom: 5px; }
        .profile-username { font-size: 16px; color: var(--tg-hint); margin-bottom: 15px; }
        .profile-stats { display: flex; justify-content: space-around; width: 100%; margin-bottom: 20px; padding: 0 20px; }
        .profile-stat { text-align: center; cursor: pointer; }
        .stat-value { font-size: 18px; font-weight: bold; }
        .stat-label { font-size: 12px; color: var(--tg-hint); }
        .profile-actions { display: flex; gap: 10px; width: 100%; padding: 0 15px; margin-bottom: 20px; }
        .profile-button { flex: 1; padding: 12px; border-radius: var(--border-radius); font-size: 14px; font-weight: bold; text-align: center; cursor: pointer; transition: opacity 0.2s ease; }
        .profile-button:active { opacity: 0.8; }
        .profile-button-primary { background-color: var(--tg-button); color: var(--tg-button-text); }
        .profile-button-secondary { background-color: var(--tg-secondary-bg); color: var(--tg-text); }
        .tabs-container { display: flex; border-bottom: 1px solid var(--tg-secondary-bg); position: sticky; top: 0; background-color: var(--tg-bg); z-index: 10; }
        .tab { flex: 1; text-align: center; padding: 15px 0; font-size: 16px; position: relative; cursor: pointer; color: var(--tg-hint); }
        .tab.active { color: var(--tg-text); font-weight: bold; }
        .tab.active::after { content: ''; position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; background-color: var(--tg-link); border-radius: 3px 3px 0 0; }
        .content-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 2px; }
        .grid-item { aspect-ratio: 9/16; background-color: var(--tg-secondary-bg); position: relative; cursor: pointer; }
        .grid-item-thumbnail { width: 100%; height: 100%; object-fit: cover; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 60vh; text-align: center; padding: 20px; color: var(--tg-hint); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background-color: var(--tg-bg); display: flex; justify-content: space-around; align-items: center; z-index: 100; border-top: 1px solid var(--tg-secondary-bg); }
        .nav-button { display: flex; flex-direction: column; align-items: center; color: var(--tg-hint); font-size: 10px; cursor: pointer; padding: 5px; flex: 1; transition: color 0.2s ease; }
        .nav-icon { font-size: 24px; margin-bottom: 3px; }
        .nav-button.active { color: var(--tg-text); font-weight: bold; }
        .create-nav-button { background: var(--tg-button); width: 45px; height: 35px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--tg-button-text); font-size: 22px; }
        .loading-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; display: flex; flex-direction: column; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--tg-secondary-bg); border-radius: 50%; border-top-color: var(--tg-link); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .comments-panel { position: fixed; bottom: 0; left: 0; width: 100%; height: 70vh; background-color: var(--tg-secondary-bg); border-radius: var(--border-radius) var(--border-radius) 0 0; transform: translateY(100%); transition: transform 0.3s ease-out; z-index: 200; display: flex; flex-direction: column; }
        .comments-panel.open { transform: translateY(0); }
        .comments-header { padding: 15px; text-align: center; font-weight: bold; border-bottom: 1px solid var(--tg-hint); position: relative; }
        .comments-header .close-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px; }
        .comments-list { flex-grow: 1; overflow-y: auto; padding: 10px 15px; }
        .comment-item { display: flex; margin-bottom: 15px; align-items: flex-start; }
        .comment-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--tg-bg); margin-right: 10px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; background-size: cover; background-position: center; }
        .comment-content .username { font-size: 14px; cursor: pointer; }
        .comment-content .text { font-size: 14px; line-height: 1.4; }
        .comment-input-container { display: flex; padding: 10px 15px; border-top: 1px solid var(--tg-hint); }
        .comment-input { flex-grow: 1; background-color: var(--tg-bg); border: none; padding: 10px; border-radius: var(--border-radius); color: var(--tg-text); }
        .comment-send-btn { background: none; border: none; color: var(--tg-link); font-size: 24px; margin-left: 10px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--tg-hint); font-size: 14px; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border-radius: var(--border-radius); border: 1px solid var(--tg-secondary-bg); background-color: var(--tg-secondary-bg); color: var(--tg-text); font-size: 16px; }
        #upload-progress { width: 100%; height: 5px; background-color: var(--tg-secondary-bg); border-radius: 5px; margin-top: 10px; display: none; }
        #upload-progress-bar { width: 0; height: 100%; background-color: var(--tg-link); border-radius: 5px; transition: width 0.2s; }
    </style>
</head>
<body>
    <!-- Страницы -->
    <div id="home-page" class="page active"><div class="video-container" id="video-container"><div class="loading-indicator"><div class="spinner"></div></div></div></div>
    <div id="discover-page" class="page"><div class="search-bar"><input type="text" class="search-input" placeholder="Поиск видео и пользователей"></div><div id="discover-content" class="content-grid"></div><div id="discover-empty" class="empty-state" style="display: none;"><i class="fas fa-search empty-state-icon"></i><div class="empty-state-text">Ничего не найдено</div></div></div>
    <div id="create-page" class="page">
        <div class="header">Создать</div>
        <div style="padding: 15px;">
            <div class="profile-button profile-button-primary" id="upload-btn">
                <i class="fas fa-upload"></i> Загрузить видео
            </div>
            <input type="file" id="video-file-input" accept="video/*" style="display: none;">
            <div id="upload-form" style="display: none; margin-top: 20px;">
                <div class="form-group">
                    <label for="video-description">Описание</label>
                    <textarea id="video-description" rows="3" placeholder="Расскажите о вашем видео..."></textarea>
                </div>
                <div class="profile-button profile-button-primary" id="publish-video-btn">Опубликовать</div>
                <div id="upload-progress"><div id="upload-progress-bar"></div></div>
            </div>
        </div>
    </div>
    <div id="inbox-page" class="page"><div class="header">Входящие</div><div id="inbox-content"><div class="empty-state"><i class="far fa-paper-plane empty-state-icon"></i><div class="empty-state-text">Здесь будут ваши чаты</div></div></div></div>
    <div id="profile-page" class="page"></div>
    <div id="edit-profile-page" class="page"></div>
    <div id="user-profile-page" class="page"></div>

    <!-- Панель комментариев -->
    <div id="comments-panel" class="comments-panel">
        <div class="comments-header">
            <span id="comments-count">0 комментариев</span>
            <i class="fas fa-times close-btn" id="close-comments-btn"></i>
        </div>
        <div class="comments-list" id="comments-list"></div>
        <div class="comment-input-container">
            <input type="text" id="comment-input" class="comment-input" placeholder="Ваш комментарий...">
            <button id="send-comment-btn" class="comment-send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    
    <!-- Навигация -->
    <div class="bottom-nav"><div class="nav-button active" data-page="home-page"><div class="nav-icon"><i class="fas fa-home"></i></div><div>Главная</div></div><div class="nav-button" data-page="discover-page"><div class="nav-icon"><i class="fas fa-search"></i></div><div>Интересное</div></div><div class="nav-button create-nav-button" data-page="create-page"><i class="fas fa-plus"></i></div><div class="nav-button" data-page="inbox-page"><div class="nav-icon"><i class="far fa-paper-plane"></i></div><div>Входящие</div></div><div class="nav-button" data-page="profile-page"><div class="nav-icon"><i class="far fa-user"></i></div><div>Профиль</div></div></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ===================================================================
            // 1. Инициализация и состояние
            // ===================================================================
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();

            const SUPABASE_URL = 'https://bbtkaiondhlxaxvcvces.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJidGthaW9uZGhseGF4dmN2Y2VzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3NDcyNDUsImV4cCI6MjA2OTMyMzI0NX0.yE-IT4RJoJQC8hAtSCgh9Nh4fX-cADts-DDxuOnVloY';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            const initDataUnsafe = tg.initDataUnsafe || {};
            const currentUser = initDataUnsafe.user || { id: 123456789, first_name: 'Test', last_name: 'User', username: 'testuser', avatar_url: null };

            const state = {
                videos: [],
                profiles: new Map(),
                currentVideoIndex: 0,
                isSwiping: false,
                activeCommentsVideoId: null,
                selectedVideoFile: null,
                subscriptions: []
            };

            // ===================================================================
            // 2. Функции API (Supabase)
            // ===================================================================
            async function fetchProfile(userId) {
                if (state.profiles.has(userId)) return state.profiles.get(userId);
                const { data, error } = await supabase.from('profiles').select().eq('id', userId).single();
                if (error) { console.error('Error fetching profile:', error); return null; }
                state.profiles.set(userId, data);
                return data;
            }

            async function upsertUserProfile() {
                const { data, error } = await supabase.from('profiles').upsert({
                    id: currentUser.id,
                    username: currentUser.username,
                    first_name: currentUser.first_name,
                    last_name: currentUser.last_name || null
                }, { onConflict: 'id' }).select().single();
                if (error) console.error('Error upserting profile:', error);
                else state.profiles.set(currentUser.id, data);
                return data;
            }

            async function fetchVideos() {
                const { data, error } = await supabase
                    .from('videos')
                    .select(`*, profiles(*), likes(user_id), saves(user_id), comments(id)`)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Error fetching videos:', error);
                    tg.showAlert('Не удалось загрузить видео.');
                    return [];
                }
                
                data.forEach(v => state.profiles.set(v.profiles.id, v.profiles));

                return data.map(v => ({
                    ...v,
                    author: v.profiles,
                    likesCount: v.likes.length,
                    commentsCount: v.comments.length,
                    isLiked: v.likes.some(like => like.user_id === currentUser.id),
                    isSaved: v.saves.some(save => save.user_id === currentUser.id)
                }));
            }
            
            async function fetchProfileStats(userId) {
                const { count: following, error: followingError } = await supabase.from('followers').select('*', { count: 'exact', head: true }).eq('follower_id', userId);
                const { count: followers, error: followersError } = await supabase.from('followers').select('*', { count: 'exact', head: true }).eq('followed_id', userId);
                const { data: userVideos, error: videosError } = await supabase.from('videos').select('likes(count)').eq('user_id', userId);

                if (followingError || followersError || videosError) {
                    console.error('Error fetching stats', followingError, followersError, videosError);
                    return { following: 0, followers: 0, likes: 0 };
                }
                const totalLikes = userVideos.reduce((acc, video) => acc + (video.likes[0]?.count || 0), 0);
                return { following, followers, likes: totalLikes };
            }

            // ===================================================================
            // 3. Функции отрисовки (Render)
            // ===================================================================
            function renderAvatar(element, profile) {
                if (profile?.avatar_url) {
                    element.style.backgroundImage = `url(${profile.avatar_url})`;
                    element.textContent = '';
                } else {
                    element.style.backgroundImage = '';
                    element.textContent = (profile?.first_name?.charAt(0) || 'U').toUpperCase();
                }
            }

            function createVideoElement(videoData, classNames = '') {
                const videoWrapper = document.createElement('div');
                videoWrapper.className = `video-wrapper ${classNames}`;
                videoWrapper.dataset.videoId = videoData.id;

                videoWrapper.innerHTML = `
                    <video class="video-player" src="${videoData.video_url}" loop muted playsinline></video>
                    <div class="video-overlay"></div>
                    <div class="loading-indicator"><div class="spinner"></div></div>
                    <div class="video-info">
                        <div class="username" data-user-id="${videoData.user_id}">@${videoData.author.username}</div>
                        <div class="description">${videoData.description}</div>
                    </div>
                    <div class="right-sidebar">
                        <div class="avatar" data-user-id="${videoData.user_id}"></div>
                        <div class="action-button like-btn">
                            <i class="action-icon ${videoData.isLiked ? 'fas liked' : 'far'} fa-heart"></i>
                            <span class="action-count">${videoData.likesCount}</span>
                        </div>
                        <div class="action-button comment-btn">
                            <i class="action-icon far fa-comment-dots"></i>
                            <span class="action-count">${videoData.commentsCount}</span>
                        </div>
                        <div class="action-button share-btn">
                            <i class="action-icon fas fa-share"></i>
                        </div>
                        <div class="action-button save-btn">
                            <i class="action-icon ${videoData.isSaved ? 'fas' : 'far'} fa-bookmark"></i>
                        </div>
                    </div>`;
                
                renderAvatar(videoWrapper.querySelector('.avatar'), videoData.author);
                
                videoWrapper.querySelector('.like-btn').addEventListener('click', (e) => { e.stopPropagation(); handleLike(videoData); });
                videoWrapper.querySelector('.save-btn').addEventListener('click', (e) => { e.stopPropagation(); handleSave(videoData); });
                videoWrapper.querySelector('.comment-btn').addEventListener('click', (e) => { e.stopPropagation(); openComments(videoData.id); });
                videoWrapper.querySelector('.share-btn').addEventListener('click', (e) => { e.stopPropagation(); handleShare(videoData); });
                videoWrapper.querySelector('.username').addEventListener('click', (e) => { e.stopPropagation(); navigateToUserProfile(videoData.user_id); });
                videoWrapper.querySelector('.avatar').addEventListener('click', (e) => { e.stopPropagation(); navigateToUserProfile(videoData.user_id); });

                let lastTap = 0;
                videoWrapper.addEventListener('click', () => { 
                    const now = new Date().getTime(); 
                    if (now - lastTap < 300) { handleLike(videoData, true); } 
                    lastTap = now; 
                });
                
                updateFollowButton(videoWrapper, videoData.user_id);
                return videoWrapper;
            }
            
            function renderVideoFeed() {
                const videoContainer = document.getElementById('video-container');
                videoContainer.innerHTML = '';
                if (state.videos.length === 0) {
                    videoContainer.innerHTML = `<div class="empty-state"><i class="fas fa-video-slash empty-state-icon"></i><div class="empty-state-text">Пока нет видео. Загрузите первое!</div></div>`;
                    return;
                }
                const prevIndex = (state.currentVideoIndex - 1 + state.videos.length) % state.videos.length;
                const nextIndex = (state.currentVideoIndex + 1) % state.videos.length;
                videoContainer.append(
                    createVideoElement(state.videos[prevIndex], 'prev'), 
                    createVideoElement(state.videos[state.currentVideoIndex], 'active'), 
                    createVideoElement(state.videos[nextIndex], 'next')
                );
                playCurrentVideo();
            }

            function playCurrentVideo() {
                document.querySelectorAll('.video-player').forEach(v => { v.pause(); v.currentTime = 0; });
                const activeVideo = document.querySelector('.video-wrapper.active .video-player');
                if (activeVideo) {
                    const loadingIndicator = activeVideo.parentElement.querySelector('.loading-indicator');
                    loadingIndicator.style.display = 'flex';
                    activeVideo.oncanplaythrough = () => {
                        loadingIndicator.style.display = 'none';
                        activeVideo.play().catch(e => console.error("Play error:", e));
                    };
                }
            }
            
            async function populateProfile(profileId) {
                const isMyProfile = profileId === currentUser.id;
                const pageId = isMyProfile ? 'profile-page' : (document.getElementById('user-profile-page').classList.contains('active') ? 'user-profile-page' : 'profile-page');
                const page = document.getElementById(pageId);
                page.innerHTML = `<div class="loading-indicator"><div class="spinner"></div></div>`;

                const profile = await fetchProfile(profileId);
                if (!profile) { page.innerHTML = "Профиль не найден."; return; }

                const stats = await fetchProfileStats(profileId);
                
                page.innerHTML = `
                    <div class="profile-header">
                        <div class="profile-avatar"></div>
                        <div class="profile-name">${profile.first_name} ${profile.last_name || ''}</div>
                        <div class="profile-username">@${profile.username}</div>
                        <div class="profile-stats">
                            <div class="profile-stat" data-stat="following"><div class="stat-value">${stats.following}</div><div class="stat-label">Подписки</div></div>
                            <div class="profile-stat" data-stat="followers"><div class="stat-value">${stats.followers}</div><div class="stat-label">Подписчики</div></div>
                            <div class="profile-stat" data-stat="likes"><div class="stat-value">${stats.likes}</div><div class="stat-label">Лайки</div></div>
                        </div>
                        <div class="profile-actions" data-user-id="${profileId}"></div>
                    </div>
                    <div class="tabs-container" id="${pageId}-tabs">
                        <div class="tab active" data-content="my-videos"><i class="fas fa-th"></i></div>
                        ${isMyProfile ? `
                        <div class="tab" data-content="liked-videos"><i class="far fa-heart"></i></div>
                        <div class="tab" data-content="saved-videos"><i class="far fa-bookmark"></i></div>` : ''}
                    </div>
                    <div class="content-grid" id="${pageId}-content-grid"></div>`;
                
                renderAvatar(page.querySelector('.profile-avatar'), profile);
                
                const actionsContainer = page.querySelector('.profile-actions');
                if (isMyProfile) {
                    actionsContainer.innerHTML = `<div class="profile-button profile-button-secondary" id="edit-profile-btn-dynamic">Изменить профиль</div>`;
                    page.querySelector('#edit-profile-btn-dynamic').addEventListener('click', openEditProfile);
                } else {
                    const { data } = await supabase.from('followers').select().eq('follower_id', currentUser.id).eq('followed_id', profileId);
                    const isFollowing = data && data.length > 0;
                    actionsContainer.innerHTML = `<div class="profile-button ${isFollowing ? 'profile-button-secondary' : 'profile-button-primary'}" id="follow-btn">${isFollowing ? 'Отписаться' : 'Подписаться'}</div>`;
                    page.querySelector('#follow-btn').addEventListener('click', () => handleFollow(profile, !isFollowing));
                }
                
                page.querySelector(`#${pageId}-tabs`).addEventListener('click', (e) => handleTabClick(e, profileId, pageId));
                
                const userVideos = await fetchUserVideos(profileId);
                renderGridContent(`${pageId}-content-grid`, userVideos);
            }

            function openEditProfile() {
                const profile = state.profiles.get(currentUser.id);
                const page = document.getElementById('edit-profile-page');
                page.innerHTML = `
                    <div class="header">Редактировать профиль</div>
                    <div style="padding: 15px; text-align: center;">
                        <div class="profile-avatar" id="edit-avatar" style="margin: 0 auto 20px auto;">
                            <div class="profile-avatar-edit-overlay"><i class="fas fa-camera"></i></div>
                        </div>
                        <input type="file" id="avatar-file-input" accept="image/*" style="display: none;">
                        <div class="form-group">
                            <input type="text" id="edit-first-name" value="${profile.first_name || ''}">
                        </div>
                        <div class="form-group">
                            <input type="text" id="edit-last-name" value="${profile.last_name || ''}">
                        </div>
                        <div class="form-group">
                            <input type="text" id="edit-username" value="${profile.username || ''}">
                        </div>
                        <div class="profile-button profile-button-primary" id="save-profile-btn">Сохранить</div>
                    </div>`;
                
                renderAvatar(page.querySelector('#edit-avatar'), profile);
                page.querySelector('#edit-avatar').addEventListener('click', () => document.getElementById('avatar-file-input').click());
                page.querySelector('#avatar-file-input').addEventListener('change', handleAvatarSelection);
                page.querySelector('#save-profile-btn').addEventListener('click', saveProfileChanges);
                navigateToPage('edit-profile-page');
            }
            
            // ===================================================================
            // 4. Навигация и управление страницами
            // ===================================================================
            function navigateToPage(pageId, context = null) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                const targetPage = document.getElementById(pageId);
                if (targetPage) targetPage.classList.add('active');

                document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
                const navButton = document.querySelector(`.nav-button[data-page="${pageId}"]`);
                if (navButton) navButton.classList.add('active');
                
                if (pageId === 'home-page') { tg.BackButton.hide(); playCurrentVideo(); } 
                else { tg.BackButton.show(); document.querySelectorAll('.video-player').forEach(v => v.pause()); }
                
                if (pageId === 'discover-page') renderGridContent('discover-content', state.videos);
                if (pageId === 'profile-page') populateProfile(currentUser.id);
                if (pageId === 'user-profile-page' && context?.userId) populateProfile(context.userId);
                
                tg.HapticFeedback.impactOccurred('light');
            }
            
            function navigateToUserProfile(userId) {
                if (userId === currentUser.id) {
                    navigateToPage('profile-page');
                } else {
                    navigateToPage('user-profile-page', { userId });
                }
            }

            function navigateVideo(direction) {
                if (state.isSwiping || state.videos.length <= 1) return;
                state.isSwiping = true;
                state.currentVideoIndex = (state.currentVideoIndex + direction + state.videos.length) % state.videos.length;
                renderVideoFeed();
                tg.HapticFeedback.impactOccurred('light');
                setTimeout(() => { state.isSwiping = false; }, 400);
            }
            
            // ===================================================================
            // 5. Обработчики действий пользователя (Handlers)
            // ===================================================================
            async function handleLike(videoData, fromDoubleTap = false) {
                const video = state.videos.find(v => v.id === videoData.id);
                if (!video) return;
                if (fromDoubleTap && video.isLiked) return;
                
                const wasLiked = video.isLiked;
                video.isLiked = !wasLiked;
                video.likesCount += video.isLiked ? 1 : -1;
                
                const videoWrapper = document.querySelector(`.video-wrapper[data-video-id="${video.id}"]`);
                if (videoWrapper) {
                    const button = videoWrapper.querySelector('.like-btn');
                    const icon = button.querySelector('i');
                    const countEl = button.querySelector('.action-count');
                    icon.classList.toggle('fas', video.isLiked);
                    icon.classList.toggle('far', !video.isLiked);
                    icon.classList.toggle('liked', video.isLiked);
                    countEl.textContent = video.likesCount;
                }

                if (fromDoubleTap && video.isLiked) {
                    const heart = document.createElement('i');
                    heart.className = 'fas fa-heart';
                    Object.assign(heart.style, { position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%) scale(0)', color: 'rgba(255, 255, 255, 0.8)', fontSize: '80px', transition: 'all 0.5s ease-out', pointerEvents: 'none', zIndex: 99 });
                    videoWrapper.appendChild(heart);
                    setTimeout(() => { heart.style.transform = 'translate(-50%, -50%) scale(1)'; heart.style.opacity = '0'; }, 10);
                    setTimeout(() => heart.remove(), 500);
                }

                tg.HapticFeedback.impactOccurred(video.isLiked ? 'medium' : 'light');

                if (video.isLiked) {
                    await supabase.from('likes').insert({ video_id: video.id, user_id: currentUser.id });
                } else {
                    await supabase.from('likes').delete().match({ video_id: video.id, user_id: currentUser.id });
                }
            }
            
            function handleShare(videoData) {
                const text = `Смотри какое видео от @${videoData.author.username}!\n${videoData.description}`;
                tg.MainButton.setText("Поделиться видео").show().onClick(() => {
                    tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(videoData.video_url)}&text=${encodeURIComponent(text)}`);
                });
                setTimeout(() => tg.MainButton.hide(), 3000);
            }

            // ... Остальные обработчики (save, comments, follow, etc.)
            
            // ===================================================================
            // 6. Realtime-подписки
            // ===================================================================
            function listenToChanges() {
                // Удаляем старые подписки перед созданием новых
                state.subscriptions.forEach(sub => supabase.removeChannel(sub));
                state.subscriptions = [];

                const likesSub = supabase.channel('public:likes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'likes' }, async (payload) => {
                        const { video_id } = payload.new || payload.old;
                        const { data } = await supabase.from('likes').select('user_id').eq('video_id', video_id);
                        const video = state.videos.find(v => v.id === video_id);
                        if(video) video.likesCount = data.length;
                        
                        const videoWrapper = document.querySelector(`.video-wrapper[data-video-id="${video_id}"] .like-btn .action-count`);
                        if (videoWrapper) videoWrapper.textContent = data.length;
                    })
                    .subscribe();
                
                state.subscriptions.push(likesSub);
                // Можно добавить подписки на комментарии, подписки и т.д.
            }

            // ===================================================================
            // 7. Инициализация приложения
            // ===================================================================
            async function main() {
                await upsertUserProfile();
                state.videos = await fetchVideos();
                renderVideoFeed();
                populateProfile(currentUser.id);
                listenToChanges();

                // Привязка обработчиков событий
                document.querySelectorAll('.nav-button').forEach(b => b.addEventListener('click', () => navigateToPage(b.dataset.page)));
                tg.BackButton.onClick(() => {
                    const activePage = document.querySelector('.page.active').id;
                    if (['user-profile-page', 'edit-profile-page'].includes(activePage)) {
                        navigateToPage('profile-page');
                    } else {
                        navigateToPage('home-page');
                    }
                });
                let touchStartY = 0;
                document.getElementById('home-page').addEventListener('touchstart', (e) => { touchStartY = e.touches[0].clientY; }, { passive: true });
                document.getElementById('home-page').addEventListener('touchend', (e) => { const dY = e.changedTouches[0].clientY - touchStartY; if (Math.abs(dY) > 50) navigateVideo(dY > 0 ? -1 : 1); }, { passive: true });
                document.querySelector('.search-input').addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    const filtered = state.videos.filter(v => v.description.toLowerCase().includes(query) || v.author.username.toLowerCase().includes(query));
                    renderGridContent('discover-content', filtered);
                    document.getElementById('discover-empty').style.display = filtered.length === 0 && query.length > 0 ? 'flex' : 'none';
                });

                // ... другие обработчики ...
                document.getElementById('upload-btn').addEventListener('click', () => document.getElementById('video-file-input').click());
                document.getElementById('video-file-input').addEventListener('change', (e) => {
                    state.selectedVideoFile = e.target.files[0];
                    if (state.selectedVideoFile) {
                        document.getElementById('upload-form').style.display = 'block';
                    }
                });
                document.getElementById('publish-video-btn').addEventListener('click', publishVideo);
            }

            main();
            
            // ===================================================================
            // Полные реализации недостающих функций
            // ===================================================================
            async function handleSave(videoData) {
                const video = state.videos.find(v => v.id === videoData.id);
                if (!video) return;
                video.isSaved = !video.isSaved;
                
                const videoWrapper = document.querySelector(`.video-wrapper[data-video-id="${video.id}"]`);
                if(videoWrapper) {
                    const icon = videoWrapper.querySelector('.save-btn i');
                    icon.classList.toggle('fas', video.isSaved);
                    icon.classList.toggle('far', !video.isSaved);
                }
                
                tg.HapticFeedback.impactOccurred('light');
                tg.showPopup({
                    title: video.isSaved ? 'Сохранено' : 'Сохранение отменено',
                    message: 'Вы всегда можете найти это видео в вашем профиле.',
                    buttons: [{ type: 'ok' }]
                });

                if (video.isSaved) {
                    await supabase.from('saves').insert({ video_id: video.id, user_id: currentUser.id });
                } else {
                    await supabase.from('saves').delete().match({ video_id: video.id, user_id: currentUser.id });
                }
            }

            async function handleFollow(profileToFollow, follow = true) {
                if (follow) {
                    await supabase.from('followers').insert({ follower_id: currentUser.id, followed_id: profileToFollow.id });
                } else {
                    await supabase.from('followers').delete().match({ follower_id: currentUser.id, followed_id: profileToFollow.id });
                }
                await populateProfile(profileToFollow.id); // Refresh the profile page
            }

            async function publishVideo() {
                if (!state.selectedVideoFile) return;
                const description = document.getElementById('video-description').value.trim();
                const publishBtn = document.getElementById('publish-video-btn');
                const progressContainer = document.getElementById('upload-progress');
                const progressBar = document.getElementById('upload-progress-bar');
                
                publishBtn.textContent = 'Публикация...';
                publishBtn.style.pointerEvents = 'none';
                progressContainer.style.display = 'block';

                const fileName = `${currentUser.id}/${Date.now()}-${state.selectedVideoFile.name}`;
                
                const { error: uploadError } = await supabase.storage.from('videos').upload(fileName, state.selectedVideoFile);

                if (uploadError) {
                    tg.showAlert('Ошибка загрузки видео.');
                    // reset button state
                    return;
                }
                
                const { data: publicUrlData } = supabase.storage.from('videos').getPublicUrl(fileName);
                
                const { error: dbError } = await supabase.from('videos').insert({ user_id: currentUser.id, description, video_url: publicUrlData.publicUrl });

                if (dbError) {
                    tg.showAlert('Ошибка сохранения видео.');
                    return;
                }
                
                tg.showPopup({ title: 'Успех!', message: 'Ваше видео опубликовано.', buttons: [{type: 'ok'}] });
                
                // Reset form and refresh data
                document.getElementById('upload-form').style.display = 'none';
                state.selectedVideoFile = null;
                state.videos = await fetchVideos();
                navigateToPage('home-page');
            }

            async function handleAvatarSelection(event) {
                const file = event.target.files[0];
                if (!file) return;
                const editAvatar = document.getElementById('edit-avatar');
                editAvatar.innerHTML = `<div class="spinner"></div>`;

                const fileName = `${currentUser.id}/avatar-${Date.now()}`;
                await supabase.storage.from('avatars').remove([`avatar-${currentUser.id}`]); // Remove old avatar
                const { error: uploadError } = await supabase.storage.from('avatars').upload(fileName, file);
                
                if (uploadError) {
                    tg.showAlert('Ошибка загрузки аватара.');
                    populateProfile(currentUser.id); // Revert to old avatar
                    return;
                }
                
                const { data: publicUrlData } = supabase.storage.from('avatars').getPublicUrl(fileName);
                const { error: dbError } = await supabase.from('profiles').update({ avatar_url: publicUrlData.publicUrl }).eq('id', currentUser.id);

                if(dbError) {
                    tg.showAlert('Ошибка обновления профиля.');
                } else {
                    const profile = await fetchProfile(currentUser.id);
                    renderAvatar(editAvatar, profile);
                }
            }

            async function saveProfileChanges() {
                 const { error } = await supabase.from('profiles').update({
                    first_name: document.getElementById('edit-first-name').value.trim(),
                    last_name: document.getElementById('edit-last-name').value.trim(),
                    username: document.getElementById('edit-username').value.trim()
                }).eq('id', currentUser.id);
                
                if (error) {
                    tg.showAlert('Не удалось обновить профиль.');
                } else {
                    tg.showPopup({ title: 'Успех!', message: 'Профиль обновлен.', buttons: [{type: 'ok'}] });
                    await fetchProfile(currentUser.id); // Re-fetch to update cache
                    navigateToPage('profile-page');
                }
            }

        });
    </script>
</body>
</html>
