<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Guid - Short Video App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Стили остаются без изменений, так как они уже используют переменные Telegram */
        :root {
            --tg-bg: var(--tg-theme-bg-color, #000000);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #aaaaaa);
            --tg-link: var(--tg-theme-link-color, #1c9eff);
            --tg-button: var(--tg-theme-button-color, #1c9eff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #111111);
            --accent-red: #ff3b30;
            --border-radius: 12px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--tg-bg); color: var(--tg-text); height: 100vh; overflow: hidden; position: relative; }
        .page { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: none; overflow-y: auto; padding-bottom: 60px; opacity: 0; transform: scale(0.98); transition: opacity 0.3s ease, transform 0.3s ease; background-color: var(--tg-bg); }
        .page.active { display: block; opacity: 1; transform: scale(1); }
        #home-page { background-color: #000; }
        .video-container { width: 100%; height: 100%; position: relative; overflow: hidden; }
        .video-wrapper { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: none; transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .video-wrapper.active { display: block; z-index: 2; transform: translateY(0); }
        .video-wrapper.next { display: block; z-index: 1; transform: translateY(100%); }
        .video-wrapper.prev { display: block; z-index: 1; transform: translateY(-100%); }
        .video-player { width: 100%; height: 100%; object-fit: cover; background-color: #000; }
        .video-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 40%); pointer-events: none; }
        .video-info { position: absolute; bottom: 75px; left: 15px; z-index: 10; max-width: 70%; color: #fff; }
        .username { font-weight: bold; font-size: 16px; margin-bottom: 5px; cursor: pointer; }
        .description { font-size: 14px; margin-bottom: 10px; line-height: 1.4; }
        .right-sidebar { position: absolute; right: 15px; bottom: 80px; display: flex; flex-direction: column; align-items: center; z-index: 10; color: #fff; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #fff; margin-bottom: 25px; background-color: var(--tg-secondary-bg); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; cursor: pointer; position: relative; }
        .follow-button { position: absolute; bottom: -10px; background-color: var(--accent-red); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; display: flex; align-items: center; justify-content: center; border: 2px solid #000; cursor: pointer; }
        .action-button { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; cursor: pointer; }
        .action-icon { font-size: 30px; margin-bottom: 5px; transition: transform 0.2s ease; }
        .action-icon.liked { color: var(--accent-red); }
        .action-button:active .action-icon { transform: scale(0.9); }
        .action-count { font-size: 13px; font-weight: 500; }
        .header { padding: 15px; font-size: 20px; font-weight: bold; position: sticky; top: 0; background-color: var(--tg-bg); z-index: 10; border-bottom: 1px solid var(--tg-secondary-bg); }
        .search-bar { display: flex; padding: 15px; position: sticky; top: 0; background-color: var(--tg-bg); z-index: 11; }
        .search-input { flex: 1; padding: 12px 15px; border-radius: var(--border-radius); border: none; background-color: var(--tg-secondary-bg); color: var(--tg-text); font-size: 16px; }
        .search-input::placeholder { color: var(--tg-hint); }
        .section-title { font-size: 18px; margin: 20px 15px 15px; font-weight: bold; }
        .profile-header { padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; background-color: var(--tg-secondary-bg); margin-bottom: 15px; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold; border: 3px solid var(--tg-link); }
        .profile-name { font-size: 22px; font-weight: bold; margin-bottom: 5px; }
        .profile-username { font-size: 16px; color: var(--tg-hint); margin-bottom: 15px; }
        .profile-stats { display: flex; justify-content: space-around; width: 100%; margin-bottom: 20px; padding: 0 20px; }
        .profile-stat { text-align: center; }
        .stat-value { font-size: 18px; font-weight: bold; }
        .stat-label { font-size: 12px; color: var(--tg-hint); }
        .profile-actions { display: flex; gap: 10px; width: 100%; padding: 0 15px; margin-bottom: 20px; }
        .profile-button { flex: 1; padding: 12px; border-radius: var(--border-radius); font-size: 14px; font-weight: bold; text-align: center; cursor: pointer; transition: opacity 0.2s ease; }
        .profile-button:active { opacity: 0.8; }
        .profile-button-primary { background-color: var(--tg-button); color: var(--tg-button-text); }
        .profile-button-secondary { background-color: var(--tg-secondary-bg); color: var(--tg-text); }
        .tabs-container { display: flex; border-bottom: 1px solid var(--tg-secondary-bg); position: sticky; top: 0; background-color: var(--tg-bg); z-index: 10; }
        .tab { flex: 1; text-align: center; padding: 15px 0; font-size: 16px; position: relative; cursor: pointer; color: var(--tg-hint); }
        .tab.active { color: var(--tg-text); font-weight: bold; }
        .tab.active::after { content: ''; position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; background-color: var(--tg-link); border-radius: 3px 3px 0 0; }
        .content-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 2px; }
        .grid-item { aspect-ratio: 9/16; background-color: var(--tg-secondary-bg); position: relative; cursor: pointer; }
        .grid-item-thumbnail { width: 100%; height: 100%; object-fit: cover; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 60vh; text-align: center; padding: 20px; color: var(--tg-hint); }
        .empty-state-icon { font-size: 50px; margin-bottom: 20px; }
        .empty-state-text { font-size: 16px; margin-bottom: 15px; }
        .create-options { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .create-option { background-color: var(--tg-secondary-bg); border-radius: var(--border-radius); padding: 20px; text-align: center; cursor: pointer; }
        .create-option:active { background-color: var(--tg-hint); }
        .create-option-icon { font-size: 30px; color: var(--tg-link); margin-bottom: 10px; }
        .create-option-title { font-size: 14px; }
        .message-list { padding: 0 15px; }
        .message-item { display: flex; align-items: center; padding: 10px 0; cursor: pointer; border-bottom: 1px solid var(--tg-secondary-bg); }
        .message-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: var(--tg-secondary-bg); margin-right: 15px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .message-body { flex-grow: 1; }
        .message-sender { font-weight: bold; }
        .message-preview { color: var(--tg-hint); font-size: 14px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background-color: var(--tg-bg); display: flex; justify-content: space-around; align-items: center; z-index: 100; border-top: 1px solid var(--tg-secondary-bg); }
        .nav-button { display: flex; flex-direction: column; align-items: center; color: var(--tg-hint); font-size: 10px; cursor: pointer; padding: 5px; flex: 1; transition: color 0.2s ease; }
        .nav-icon { font-size: 24px; margin-bottom: 3px; }
        .nav-button.active { color: var(--tg-text); font-weight: bold; }
        .create-nav-button { background: var(--tg-button); width: 45px; height: 35px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--tg-button-text); font-size: 22px; }
        .loading-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; display: flex; flex-direction: column; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--tg-secondary-bg); border-radius: 50%; border-top-color: var(--tg-link); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* == НОВЫЕ И ИЗМЕНЕННЫЕ СТИЛИ == */
        
        /* 1. Отступ 40px для fullsize-режима на указанных страницах */
        #discover-page, #create-page, #inbox-page, #profile-page, #user-profile-page, #edit-profile-page {
            padding-top: 40px;
        }

        /* 2. Стили для панели комментариев, высота изменена на 80vh */
        .comments-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80vh; /* ИЗМЕНЕНО: высота увеличена до 80% экрана */
            background-color: var(--tg-secondary-bg);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            z-index: 200;
            display: flex;
            flex-direction: column;
        }
        .comments-panel.open { transform: translateY(0); }
        .comments-header { padding: 15px; text-align: center; font-weight: bold; border-bottom: 1px solid var(--tg-hint); position: relative; flex-shrink: 0; }
        .comments-header .close-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px; }
        .comments-list { flex-grow: 1; overflow-y: auto; padding: 10px 15px; }
        .comment-item { display: flex; margin-bottom: 15px; }
        .comment-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--tg-bg); margin-right: 10px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .comment-content .username { font-size: 14px; }
        .comment-content .text { font-size: 14px; line-height: 1.4; }
        .comment-input-container { display: flex; padding: 10px 15px; border-top: 1px solid var(--tg-hint); flex-shrink: 0; }
        .comment-input { flex-grow: 1; background-color: var(--tg-bg); border: none; padding: 10px; border-radius: var(--border-radius); color: var(--tg-text); }
        .comment-send-btn { background: none; border: none; color: var(--tg-link); font-size: 24px; margin-left: 10px; cursor: pointer; }
        
        /* Стили для формы загрузки */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--tg-hint); font-size: 14px; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border-radius: var(--border-radius); border: 1px solid var(--tg-secondary-bg); background-color: var(--tg-secondary-bg); color: var(--tg-text); font-size: 16px; }
        #upload-progress { width: 100%; height: 5px; background-color: var(--tg-secondary-bg); border-radius: 5px; margin-top: 10px; display: none; }
        #upload-progress-bar { width: 0; height: 100%; background-color: var(--tg-link); border-radius: 5px; transition: width 0.2s; }
    </style>
</head>
<body>
    <div id="home-page" class="page active"><div class="video-container" id="video-container"><div class="loading-indicator"><div class="spinner"></div></div></div></div>
    <div id="discover-page" class="page"><div class="search-bar"><input type="text" class="search-input" placeholder="Поиск видео и пользователей"></div><div id="discover-content" class="content-grid"></div><div id="discover-empty" class="empty-state" style="display: none;"><div class="empty-state-icon"><i class="fas fa-search"></i></div><div class="empty-state-text">Ничего не найдено</div></div></div>
    
    <div id="create-page" class="page">
        <div class="header">Создать видео</div>
        <input type="file" id="video-file-input" accept="video/*" style="display: none;">
        
        <div id="upload-form" style="display: none; padding: 15px;">
            <div class="form-group">
                <label for="video-description">Описание</label>
                <textarea id="video-description" rows="3" placeholder="Расскажите о вашем видео..."></textarea>
            </div>
            <div class="profile-button profile-button-primary" id="publish-video-btn">Опубликовать</div>
            <div id="upload-progress"><div id="upload-progress-bar"></div></div>
        </div>
        <div class="create-options" style="display: none;"></div>
    </div>

    <div id="inbox-page" class="page"><div class="header">Входящие</div><div id="inbox-content"><div class="empty-state"><div class="empty-state-icon"><i class="far fa-paper-plane"></i></div><div class="empty-state-text">Здесь будут ваши чаты</div></div></div></div>
    <div id="profile-page" class="page"></div>
    <div id="edit-profile-page" class="page">
        <div class="header">Редактировать профиль</div>
        <div style="padding: 15px;">
            <div class="form-group">
                <label for="edit-first-name">Имя</label>
                <input type="text" id="edit-first-name">
            </div>
            <div class="form-group">
                <label for="edit-last-name">Фамилия</label>
                <input type="text" id="edit-last-name">
            </div>
            <div class="form-group">
                <label for="edit-username">Имя пользователя</label>
                <input type="text" id="edit-username">
            </div>
            <div class="profile-button profile-button-primary" id="save-profile-btn">Сохранить</div>
        </div>
    </div>
    <div id="user-profile-page" class="page"></div>

    <div id="comments-panel" class="comments-panel">
        <div class="comments-header">
            <span id="comments-count">0 комментариев</span>
            <i class="fas fa-times close-btn" id="close-comments-btn"></i>
        </div>
        <div class="comments-list" id="comments-list"></div>
        <div class="comment-input-container">
            <input type="text" id="comment-input" class="comment-input" placeholder="Ваш комментарий...">
            <button id="send-comment-btn" class="comment-send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    
    <div class="bottom-nav"><div class="nav-button active" data-page="home-page"><div class="nav-icon"><i class="fas fa-home"></i></div><div>Главная</div></div><div class="nav-button" data-page="discover-page"><div class="nav-icon"><i class="fas fa-search"></i></div><div>Интересное</div></div><div class="nav-button create-nav-button" data-page="create-page"><i class="fas fa-plus"></i></div><div class="nav-button" data-page="inbox-page"><div class="nav-icon"><i class="far fa-paper-plane"></i></div><div>Входящие</div></div><div class="nav-button" data-page="profile-page"><div class="nav-icon"><i class="far fa-user"></i></div><div>Профиль</div></div></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ===================================================================
            // 1. Инициализация SDK и клиентов
            // ===================================================================
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();

            const SUPABASE_URL = 'https://bbtkaiondhlxaxvcvces.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJidGthaW9uZGhseGF4dmN2Y2VzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3NDcyNDUsImV4cCI6MjA2OTMyMzI0NX0.yE-IT4RJoJQC8hAtSCgh9Nh4fX-cADts-DDxuOnVloY';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            const initDataUnsafe = tg.initDataUnsafe || {};
            const user = initDataUnsafe.user || { id: 123456789, first_name: 'Test', last_name: 'User', username: 'testuser' };

            // ===================================================================
            // 2. Глобальные переменные состояния
            // ===================================================================
            let videos = [];
            let currentVideoIndex = 0;
            let isSwiping = false;
            let activeCommentsVideoId = null;
            let selectedFile = null;

            // ===================================================================
            // 3. Функции для работы с API Supabase
            // ===================================================================

            async function upsertUserProfile() {
                const { data, error } = await supabase.from('profiles').upsert({
                    id: user.id,
                    username: user.username,
                    first_name: user.first_name,
                    last_name: user.last_name || null
                }, { onConflict: 'id' }).select().single();
                if (error) console.error('Error upserting profile:', error);
                return data;
            }

            async function fetchVideos() {
                const { data, error } = await supabase
                    .from('videos')
                    .select(`
                        id, video_url, description, user_id,
                        profiles ( id, username, first_name, last_name ),
                        likes ( user_id ),
                        saves ( user_id ),
                        comments ( id )
                    `)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Error fetching videos:', error);
                    tg.showAlert('Не удалось загрузить видео.');
                    return [];
                }
                
                return data.map(v => ({
                    id: v.id, url: v.video_url, description: v.description, userId: v.user_id,
                    username: v.profiles.username, author: v.profiles,
                    likesCount: v.likes.length, commentsCount: v.comments.length,
                    isLiked: v.likes.some(like => like.user_id === user.id),
                    isSaved: v.saves.some(save => save.user_id === user.id)
                }));
            }
            
            async function fetchProfileStats(userId) {
                const { data: following, error: followingError } = await supabase.from('followers').select('followed_id').eq('follower_id', userId);
                const { data: followers, error: followersError } = await supabase.from('followers').select('follower_id').eq('followed_id', userId);
                const { data: userVideos, error: videosError } = await supabase.from('videos').select('likes(count)').eq('user_id', userId);

                if (followingError || followersError || videosError) {
                    console.error('Error fetching stats', followingError, followersError, videosError);
                    return { following: 0, followers: 0, likes: 0 };
                }

                const totalLikes = userVideos.reduce((acc, video) => acc + (video.likes[0]?.count || 0), 0);
                
                return {
                    following: following.length,
                    followers: followers.length,
                    likes: totalLikes
                };
            }

            // ===================================================================
            // 4. Функции для отрисовки интерфейса
            // ===================================================================

            function createVideoElement(videoData, classNames = '') {
                const videoWrapper = document.createElement('div');
                videoWrapper.className = `video-wrapper ${classNames}`;
                videoWrapper.dataset.videoId = videoData.id;

                videoWrapper.innerHTML = `
                    <video class="video-player" src="${videoData.url}" loop muted playsinline></video>
                    <div class="video-overlay"></div>
                    <div class="loading-indicator"><div class="spinner"></div></div>
                    <div class="video-info">
                        <div class="username" data-user-id="${videoData.userId}">@${videoData.username}</div>
                        <div class="description">${videoData.description}</div>
                    </div>
                    <div class="right-sidebar">
                        <div class="avatar" data-user-id="${videoData.userId}">${videoData.username.charAt(0).toUpperCase()}
                           </div>
                        <div class="action-button like-btn">
                            <i class="action-icon ${videoData.isLiked ? 'fas liked' : 'far'} fa-heart"></i>
                            <div class="action-count">${videoData.likesCount}</div>
                        </div>
                        <div class="action-button comment-btn">
                            <i class="action-icon far fa-comment-dots"></i>
                            <div class="action-count">${videoData.commentsCount}</div>
                        </div>
                        <div class="action-button save-btn">
                            <i class="action-icon ${videoData.isSaved ? 'fas' : 'far'} fa-bookmark"></i>
                        </div>
                    </div>`;
                
                // Event Listeners
                videoWrapper.querySelector('.like-btn').addEventListener('click', (e) => { e.stopPropagation(); handleLike(videoWrapper, videoData); });
                videoWrapper.querySelector('.save-btn').addEventListener('click', (e) => { e.stopPropagation(); handleSave(videoWrapper, videoData); });
                videoWrapper.querySelector('.comment-btn').addEventListener('click', (e) => { e.stopPropagation(); openComments(videoData.id); });
                videoWrapper.querySelector('.username').addEventListener('click', (e) => { e.stopPropagation(); navigateToUserProfile(videoData.userId); });
                videoWrapper.querySelector('.avatar').addEventListener('click', (e) => { e.stopPropagation(); navigateToUserProfile(videoData.userId); });

                let lastTap = 0;
                videoWrapper.addEventListener('click', () => { 
                    const now = new Date().getTime(); 
                    if (now - lastTap < 300) { handleLike(videoWrapper, videoData, true); } 
                    lastTap = now; 
                });
                
                updateFollowButton(videoWrapper, videoData.userId);

                return videoWrapper;
            }
            
            function renderVideoFeed() {
                const videoContainer = document.getElementById('video-container');
                videoContainer.innerHTML = '<div class="loading-indicator"><div class="spinner"></div></div>'; // Clear with loading
                if (videos.length === 0) {
                    videoContainer.innerHTML = `<div class="empty-state"><div class="empty-state-icon"><i class="fas fa-video-slash"></i></div><div class="empty-state-text">Пока нет видео. Загрузите первое!</div></div>`;
                    return;
                }
                videoContainer.innerHTML = ''; // Clear loading
                const prevIndex = (currentVideoIndex - 1 + videos.length) % videos.length;
                const nextIndex = (currentVideoIndex + 1) % videos.length;
                videoContainer.append(createVideoElement(videos[prevIndex], 'prev'), createVideoElement(videos[currentVideoIndex], 'active'), createVideoElement(videos[nextIndex], 'next'));
                playCurrentVideo();
            }

            function playCurrentVideo() {
                document.querySelectorAll('.video-player').forEach(v => { v.pause(); v.currentTime = 0; });
                const activeVideo = document.querySelector('.video-wrapper.active .video-player');
                if (activeVideo) {
                    const loadingIndicator = activeVideo.parentElement.querySelector('.loading-indicator');
                    loadingIndicator.style.display = 'flex';
                    activeVideo.oncanplay = () => {
                        loadingIndicator.style.display = 'none';
                        activeVideo.play().catch(e => console.error("Play error:", e));
                    };
                    activeVideo.load(); // Ensure video starts loading
                }
            }

            function navigateVideo(direction) {
                if (isSwiping || videos.length <= 1) return;
                isSwiping = true;
                
                currentVideoIndex = (currentVideoIndex + direction + videos.length) % videos.length;
                
                renderVideoFeed(); 
                
                tg.HapticFeedback.impactOccurred('light');
                setTimeout(() => { isSwiping = false; }, 400); // Match transition duration
            }

            function createGridItem(video) {
                const item = document.createElement('div');
                item.className = 'grid-item';
                item.innerHTML = `<video muted playsinline class="grid-item-thumbnail" src="${video.url}#t=0.5" preload="metadata"></video>`;
                item.addEventListener('click', () => {
                   const videoIndex = videos.findIndex(v => v.id === video.id);
                   if (videoIndex > -1) {
                        currentVideoIndex = videoIndex;
                        renderVideoFeed();
                        navigateToPage('home-page');
                   }
                });
                return item;
            }

            function renderGridContent(containerId, data, emptyText = "Здесь пока пусто") {
                const grid = document.getElementById(containerId);
                grid.innerHTML = '';
                if (data.length === 0) {
                    grid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><div class="empty-state-icon"><i class="fas fa-video-slash"></i></div><div class="empty-state-text">${emptyText}</div></div>`;
                    return;
                }
                data.forEach(video => grid.appendChild(createGridItem(video)));
            }
            
            async function populateProfile(profileId) {
                const isMyProfile = profileId === user.id;
                const pageId = isMyProfile ? 'profile-page' : 'user-profile-page';
                const page = document.getElementById(pageId);
                page.innerHTML = '<div class="loading-indicator"><div class="spinner"></div></div>';
                
                const { data: profile, error } = await supabase.from('profiles').select().eq('id', profileId).single();
                if (error) { console.error('Error fetching profile', error); page.innerHTML = 'Не удалось загрузить профиль.'; return; }

                const stats = await fetchProfileStats(profileId);
                
                const profileHTML = `
                    <div class="profile-header">
                        <div class="profile-avatar">${(profile.first_name.charAt(0) + (profile.last_name?.charAt(0) || '')).toUpperCase()}</div>
                        <div class="profile-name">${profile.first_name} ${profile.last_name || ''}</div>
                        <div class="profile-username">@${profile.username}</div>
                        <div class="profile-stats">
                            <div class="profile-stat"><div class="stat-value">${stats.following}</div><div class="stat-label">Подписки</div></div>
                            <div class="profile-stat"><div class="stat-value">${stats.followers}</div><div class="stat-label">Подписчики</div></div>
                            <div class="profile-stat"><div class="stat-value">${stats.likes}</div><div class="stat-label">Лайки</div></div>
                        </div>
                        <div class="profile-actions" data-user-id="${profileId}"></div>
                    </div>
                    <div class="tabs-container" id="${pageId}-tabs">
                        <div class="tab active" data-content="my-videos"><i class="fas fa-th"></i></div>
                        ${isMyProfile ? `
                        <div class="tab" data-content="liked-videos"><i class="far fa-heart"></i></div>
                        <div class="tab" data-content="saved-videos"><i class="far fa-bookmark"></i></div>
                        ` : ''}
                    </div>
                    <div class="content-grid" id="${pageId}-content-grid"></div>`;
                
                page.innerHTML = profileHTML;
                
                const actionsContainer = page.querySelector('.profile-actions');
                if (isMyProfile) {
                    actionsContainer.innerHTML = `<div class="profile-button profile-button-secondary" id="edit-profile-btn-dynamic">Изменить профиль</div>`;
                    page.querySelector('#edit-profile-btn-dynamic').addEventListener('click', openEditProfile);
                } else {
                    const { data: isFollowing } = await supabase.from('followers').select().eq('follower_id', user.id).eq('followed_id', profileId);
                    if (isFollowing.length > 0) {
                        actionsContainer.innerHTML = `<div class="profile-button profile-button-secondary" id="unfollow-btn">Отписаться</div>`;
                        page.querySelector('#unfollow-btn').addEventListener('click', () => handleFollow(profileId, false));
                    } else {
                        actionsContainer.innerHTML = `<div class="profile-button profile-button-primary" id="follow-btn">Подписаться</div>`;
                        page.querySelector('#follow-btn').addEventListener('click', () => handleFollow(profileId, true));
                    }
                }
                
                page.querySelector(`#${pageId}-tabs`).addEventListener('click', (e) => handleTabClick(e, profileId, pageId));
                
                const userVideos = await fetchUserVideos(profileId);
                renderGridContent(`${pageId}-content-grid`, userVideos);
            }

            function navigateToPage(pageId) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
                const navButton = document.querySelector(`.nav-button[data-page="${pageId}"]`);
                if (navButton) navButton.classList.add('active');
                
                if (pageId === 'home-page') { 
                    tg.BackButton.hide(); 
                    playCurrentVideo(); 
                } else { 
                    tg.BackButton.show(); 
                    document.querySelectorAll('.video-player').forEach(v => v.pause()); 
                }
                
                if (pageId === 'discover-page' && document.getElementById('discover-content').innerHTML === '') populateDiscoverPage();
                if (pageId === 'profile-page') populateProfile(user.id);
                
                tg.HapticFeedback.impactOccurred('light');
            }
            
            function navigateToUserProfile(userId) {
                if (userId === user.id) {
                    navigateToPage('profile-page');
                } else {
                    populateProfile(userId);
                    navigateToPage('user-profile-page');
                }
            }

            // ... Остальные функции (handleLike, handleSave и т.д.) остаются без изменений ...
            async function handleLike(videoWrapper, videoData, fromDoubleTap = false) {
                if (fromDoubleTap && videoData.isLiked) return;
                videoData.isLiked = !videoData.isLiked;
                videoData.likesCount += videoData.isLiked ? 1 : -1;
                const button = videoWrapper.querySelector('.like-btn');
                const icon = button.querySelector('i');
                const countEl = button.querySelector('.action-count');
                icon.classList.toggle('fas', videoData.isLiked);
                icon.classList.toggle('far', !videoData.isLiked);
                icon.classList.toggle('liked', videoData.isLiked);
                countEl.textContent = videoData.likesCount;
                if (fromDoubleTap && videoData.isLiked) {
                    const heart = document.createElement('i');
                    heart.className = 'fas fa-heart';
                    Object.assign(heart.style, { position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%) scale(0)', color: 'rgba(255, 255, 255, 0.8)', fontSize: '80px', transition: 'all 0.5s ease-out', pointerEvents: 'none', zIndex: 99 });
                    videoWrapper.appendChild(heart);
                    setTimeout(() => { heart.style.transform = 'translate(-50%, -50%) scale(1)'; heart.style.opacity = '0'; }, 10);
                    setTimeout(() => heart.remove(), 500);
                }
                tg.HapticFeedback.impactOccurred(videoData.isLiked ? 'medium' : 'light');
                if (videoData.isLiked) {
                    await supabase.from('likes').insert({ video_id: videoData.id, user_id: user.id });
                } else {
                    await supabase.from('likes').delete().match({ video_id: videoData.id, user_id: user.id });
                }
            }
            async function handleSave(videoWrapper, videoData) {
                videoData.isSaved = !videoData.isSaved;
                const icon = videoWrapper.querySelector('.save-btn i');
                icon.classList.toggle('fas', videoData.isSaved);
                icon.classList.toggle('far', !videoData.isSaved);
                tg.HapticFeedback.impactOccurred('light');
                tg.showPopup({
                    title: videoData.isSaved ? 'Сохранено' : 'Сохранение отменено',
                    message: 'Вы всегда можете найти это видео во вкладке "Сохраненное" в вашем профиле.',
                    buttons: [{ type: 'ok' }]
                });
                if (videoData.isSaved) {
                    await supabase.from('saves').insert({ video_id: videoData.id, user_id: user.id });
                } else {
                    await supabase.from('saves').delete().match({ video_id: videoData.id, user_id: user.id });
                }
            }
            async function openComments(videoId) {
                activeCommentsVideoId = videoId;
                const panel = document.getElementById('comments-panel');
                const list = document.getElementById('comments-list');
                const countEl = document.getElementById('comments-count');
                list.innerHTML = '<div class="loading-indicator"><div class="spinner"></div></div>';
                panel.classList.add('open');
                const { data, error, count } = await supabase.from('comments')
                    .select('*, profiles(username)', { count: 'exact' })
                    .eq('video_id', videoId)
                    .order('created_at', { ascending: true });
                if (error) {
                    console.error('Error fetching comments:', error);
                    list.innerHTML = 'Не удалось загрузить комментарии.';
                    return;
                }
                countEl.textContent = `${count} комментариев`;
                list.innerHTML = '';
                if (data.length === 0) {
                    list.innerHTML = '<div class="empty-state" style="height: auto;"><div class="empty-state-text">Комментариев пока нет. Будьте первым!</div></div>';
                } else {
                    data.forEach(comment => {
                        const item = document.createElement('div');
                        item.className = 'comment-item';
                        item.innerHTML = `
                            <div class="comment-avatar">${comment.profiles.username.charAt(0).toUpperCase()}</div>
                            <div class="comment-content">
                                <div class="username">@${comment.profiles.username}</div>
                                <div class="text">${comment.text}</div>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                }
            }
            function closeComments() {
                document.getElementById('comments-panel').classList.remove('open');
                activeCommentsVideoId = null;
            }
            async function postComment() {
                const input = document.getElementById('comment-input');
                const text = input.value.trim();
                if (!text || !activeCommentsVideoId) return;
                const { data, error } = await supabase.from('comments').insert({
                    text: text, user_id: user.id, video_id: activeCommentsVideoId
                }).select('*, profiles(username)').single();
                if (error) {
                    console.error('Error posting comment:', error);
                    tg.showAlert('Не удалось отправить комментарий.');
                    return;
                }
                input.value = '';
                const list = document.getElementById('comments-list');
                const item = document.createElement('div');
                item.className = 'comment-item';
                item.innerHTML = `
                    <div class="comment-avatar">${data.profiles.username.charAt(0).toUpperCase()}</div>
                    <div class="comment-content">
                        <div class="username">@${data.profiles.username}</div>
                        <div class="text">${data.text}</div>
                    </div>`;
                if(list.querySelector('.empty-state')) list.innerHTML = '';
                list.appendChild(item);
                list.scrollTop = list.scrollHeight;
                const video = videos.find(v => v.id === activeCommentsVideoId);
                if (video) {
                    video.commentsCount++;
                    const videoWrapper = document.querySelector(`.video-wrapper[data-video-id="${activeCommentsVideoId}"]`);
                    if (videoWrapper) {
                        videoWrapper.querySelector('.comment-btn .action-count').textContent = video.commentsCount;
                    }
                }
            }
            async function handleFollow(followedId, follow = true) {
                if (follow) {
                    const { error } = await supabase.from('followers').insert({ follower_id: user.id, followed_id: followedId });
                    if (error) console.error("Follow error", error);
                } else {
                    const { error } = await supabase.from('followers').delete().match({ follower_id: user.id, followed_id: followedId });
                    if (error) console.error("Unfollow error", error);
                }
                await populateProfile(followedId); // Refresh profile UI
                const activeVideoWrapper = document.querySelector('.video-wrapper.active');
                if (activeVideoWrapper) await updateFollowButton(activeVideoWrapper, followedId);
            }
            async function updateFollowButton(videoWrapper, authorId) {
                const avatarDiv = videoWrapper.querySelector('.avatar');
                const existingBtn = avatarDiv.querySelector('.follow-button');
                if (existingBtn) existingBtn.remove();
                if (authorId === user.id) return;
                const { data } = await supabase.from('followers').select().eq('follower_id', user.id).eq('followed_id', authorId);
                if (!data || data.length === 0) {
                    const followBtn = document.createElement('div');
                    followBtn.className = 'follow-button';
                    followBtn.textContent = '+';
                    followBtn.onclick = (e) => { e.stopPropagation(); handleFollow(authorId, true); };
                    avatarDiv.appendChild(followBtn);
                }
            }
            // ===================================================================
            // 6. ИЗМЕНЕННАЯ Логика загрузки видео
            // ===================================================================
            
            // Listener для скрытого input'а
            document.getElementById('video-file-input').addEventListener('change', (event) => {
                selectedFile = event.target.files[0];
                if (selectedFile) {
                    // После выбора файла переходим на страницу создания и показываем форму
                    navigateToPage('create-page');
                    document.querySelector('#create-page .upload-form').style.display = 'block';
                }
                // Сбрасываем значение, чтобы событие сработало снова при выборе того же файла
                event.target.value = null; 
            });

            // Listener для кнопки публикации
            document.getElementById('publish-video-btn').addEventListener('click', async () => {
                if (!selectedFile) {
                    tg.showAlert('Пожалуйста, выберите файл для загрузки.');
                    return;
                }
                const description = document.getElementById('video-description').value.trim();
                const publishBtn = document.getElementById('publish-video-btn');
                const progressContainer = document.getElementById('upload-progress');
                const progressBar = document.getElementById('upload-progress-bar');
                
                publishBtn.textContent = 'Публикация...';
                publishBtn.style.pointerEvents = 'none';
                progressContainer.style.display = 'block';

                const fileName = `${user.id}/${Date.now()}-${selectedFile.name}`;
                
                const { error: uploadError } = await supabase.storage
                    .from('videos')
                    .upload(fileName, selectedFile); // Убрана симуляция прогресса для простоты

                if (uploadError) {
                    console.error('Upload error:', uploadError);
                    tg.showAlert('Ошибка загрузки видео.');
                    // (код сброса кнопки)
                    return;
                }
                
                progressBar.style.width = '100%'; 

                const { data: publicUrlData } = supabase.storage.from('videos').getPublicUrl(fileName);
                
                const { error: dbError } = await supabase.from('videos').insert({
                    user_id: user.id,
                    description: description,
                    video_url: publicUrlData.publicUrl
                });

                if (dbError) {
                    console.error('Database error:', dbError);
                    tg.showAlert('Ошибка сохранения видео.');
                    // (код сброса кнопки)
                    return;
                }
                
                tg.showPopup({ title: 'Успех!', message: 'Ваше видео опубликовано.', buttons: [{type: 'ok'}] });
                
                // Сброс формы и состояния
                document.getElementById('upload-form').style.display = 'none';
                document.getElementById('video-description').value = '';
                selectedFile = null;
                publishBtn.textContent = 'Опубликовать';
                publishBtn.style.pointerEvents = 'auto';
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
                
                // Обновляем данные и переходим на главную
                await main(true);
                navigateToPage('home-page');
            });
            
            // ... Код для редактирования профиля и вкладок ...
             function openEditProfile() {
                // Код для открытия страницы редактирования профиля
            }
            document.getElementById('save-profile-btn').addEventListener('click', async () => {
                // Код сохранения профиля
            });
            async function fetchUserVideos(profileId) {
                // код получения видео пользователя
                 const { data, error } = await supabase.from('videos').select(`*, profiles(*), likes(*), saves(*), comments(*)`).eq('user_id', profileId).order('created_at', { ascending: false });
                 if (error) return [];
                 return data.map(v => ({
                     id: v.id, url: v.video_url, description: v.description, userId: v.user_id, username: v.profiles.username,
                     author: v.profiles, likesCount: v.likes.length, commentsCount: v.comments.length,
                     isLiked: v.likes.some(like => like.user_id === user.id),
                     isSaved: v.saves.some(save => save.user_id === user.id)
                 }));
            }
            async function handleTabClick(e, profileId, pageId) {
                 // код обработки кликов по табам в профиле
                 const tab = e.target.closest('.tab');
                 if (!tab) return;
                 document.querySelectorAll(`#${pageId}-tabs .tab`).forEach(t => t.classList.remove('active'));
                 tab.classList.add('active');
                 const content = tab.dataset.content;
                 const gridId = `${pageId}-content-grid`;
                 let videosToShow = [];
                 if (content === 'my-videos') { /* ... */ }
                 else if (content === 'liked-videos') { /* ... */ }
                 else if (content === 'saved-videos') { /* ... */ }
            }
            
            // ===================================================================
            // 9. ИЗМЕНЕННАЯ Инициализация приложения
            // ===================================================================
            
            // ИЗМЕНЕНО: Настройка навигации
            document.querySelectorAll('.nav-button').forEach(button => {
                if (button.classList.contains('create-nav-button')) {
                    // Кнопка "Создать" сразу открывает диалог выбора файла
                    button.addEventListener('click', () => {
                        document.getElementById('video-file-input').click();
                    });
                } else {
                    // Остальные кнопки работают как раньше
                    button.addEventListener('click', () => navigateToPage(button.dataset.page));
                }
            });

            // ИЗМЕНЕНО: Обработка кнопки "Назад" в Telegram
            tg.BackButton.onClick(() => {
                const activePageId = document.querySelector('.page.active').id;
                
                if (activePageId === 'create-page') {
                    // При выходе со страницы создания сбрасываем ее состояние
                    document.getElementById('upload-form').style.display = 'none';
                    document.getElementById('video-file-input').value = null;
                    selectedFile = null;
                    navigateToPage('home-page');
                } else if (activePageId === 'user-profile-page' || activePageId === 'edit-profile-page') {
                    navigateToPage('profile-page');
                } else {
                    navigateToPage('home-page');
                }
            });
            
            // Остальные обработчики
            let touchStartY = 0;
            document.getElementById('home-page').addEventListener('touchstart', (e) => { touchStartY = e.touches[0].clientY; }, { passive: true });
            document.getElementById('home-page').addEventListener('touchend', (e) => { const dY = e.changedTouches[0].clientY - touchStartY; if (Math.abs(dY) > 50) navigateVideo(dY > 0 ? -1 : 1); }, { passive: true });
            
            document.querySelector('.search-input').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const filteredVideos = videos.filter(v => v.description.toLowerCase().includes(query) || v.username.toLowerCase().includes(query));
                document.getElementById('discover-empty').style.display = filteredVideos.length === 0 && query.length > 0 ? 'flex' : 'none';
                renderGridContent('discover-content', filteredVideos);
            });
            
            document.getElementById('close-comments-btn').addEventListener('click', closeComments);
            document.getElementById('send-comment-btn').addEventListener('click', postComment);
            document.getElementById('comment-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') postComment(); });
            
            async function main(forceRefresh = false) {
                await upsertUserProfile();
                if (forceRefresh || videos.length === 0) {
                    videos = await fetchVideos();
                }
                renderVideoFeed();
                populateProfile(user.id);
            }

            main();
        });
    </script>
</body>
</html>
